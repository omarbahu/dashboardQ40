@using System.Data
@model dashboardQ40.Models.TrazabilidadConChecklistViewModel

@{
    ViewBag.Title = "Reporte de Trazabilidad Hacia Atrás";
}

<div class="container mt-5">
    <h2>Reporte de Trazabilidad Hacia Atrás</h2>

    <form method="get" action="@Url.Action("ReportTrazability", "Trazability")" class="d-flex align-items-center gap-2 mb-2">
        <input type="text" name="searchBatch" class="form-control form-control-sm w-auto" placeholder="Buscar lote..." value="@Model.SearchBatch" style="max-width: 200px;" />
        <button type="submit" class="btn btn-sm btn-primary">Buscar</button>
    </form>
    </BR></BR>
    @if (Model.StartDate.HasValue && Model.EndDate.HasValue)
    {
        <div class="d-flex align-items-center gap-3 flex-wrap mb-3">
            <div style="flex: 1; min-width: 280px; padding-bottom: 10px;">
                <div id="rangeSlider"></div>
            </div>

            <div class="small d-flex gap-2 flex-wrap align-items-center">
                <span><strong>Desde:</strong> <span id="displayStart"></span></span>
                <span><strong>Hasta:</strong> <span id="displayEnd"></span></span>

                <form method="get" action="@Url.Action("ReportTrazability", "Trazability")" class="d-flex align-items-center gap-2">
                    <input type="hidden" name="searchBatch" value="@Model.SearchBatch" />
                    <input type="hidden" id="startDateInput" name="startDate" />
                    <input type="hidden" id="endDateInput" name="endDate" />
                    <button type="submit" class="btn btn-sm btn-outline-secondary">🔍 Filtrar</button>
                </form>
            </div>
        </div>
    }
    </BR></BR>
    @if (Model.Checklist != null && Model.Checklist.Rows.Count > 0)
    {
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Lote</th>
                    <th>Identificador Lote</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th>SKU</th>                    
                    <th>Línea</th>
                    <th>Variable</th>
                    <th>Resultado</th>
                    <th>Min</th>
                    <th>Max</th>

                    <!-- Nuevas columnas estadísticas -->
                    <th>Conteo</th>
                    <th>Defectos</th>
                    <th>Media</th>
                    <th>Sigma</th>
                    <th>Cp</th>
                    <th>Cpk</th>
                </tr>
            </thead>
            <tbody>
                @{
                    string previousBatch = string.Empty;
                    string previousManufacturingReference = string.Empty;
                }

                @foreach (System.Data.DataRow batchRow in Model.Trazabilidad.Rows)
                {
                    string batch = batchRow["batch"].ToString@Localizer["();"]
                    string batchIdentifier = batchRow["batchname"].ToString@Localizer["();"]
                    string creacionLote = batchRow["startDate"].ToString@Localizer["();"]
                    string finLote = batchRow["endDate"].ToString@Localizer["();"]
                    string manufacturingReference = batchRow["manufacturingReferencename"].ToString@Localizer["();"]

                    // Obtener checklist asociados a este batch
                                    var checklistFiltrados = new List<DataRow>@Localizer["@Localizer["();"]"]

                                    foreach (DataRow c in Model.Checklist.Rows)
                                    {
                                        if (c["batch"].ToString() == batch)
                                        {
                                            checklistFiltrados.Add(c);
                                        }
                                    }

                    if (checklistFiltrados.Count == 0)
                    {
                        // Mostrar solo la fila del batch, sin checklist
                        <tr>
                            <td>@batch</td>
                            <td>@batchIdentifier</td>
                            <td>@creacionLote</td>
                            <td>@finLote</td>
                            <td>@manufacturingReference</td>
                            <td colspan="12">Sin registros de checklist</td>
                        </tr>
                    }
                    else
                    {
                        bool mostrarInfoLote = true;

                        foreach (var row in checklistFiltrados)
                        {
                            string variable = row["controlOperationName"].ToString@Localizer["();"]
                            string key = $"{batch}|{variable}";
                            var stats = Model.Estadisticas.ContainsKey(key) ? Model.Estadisticas[key] : null;

                            <tr>
                                @if (mostrarInfoLote)
                                {
                                    <td>@batch</td>
                                    <td>@batchIdentifier</td>
                                    <td>@creacionLote</td>
                                    <td>@finLote</td>
                                    <td>@manufacturingReference</td>
                                    mostrarInfoLote = false; // Ya mostramos, ahora ocultar en siguientes
                                }
                                else
                                {
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                }

                                <td>
                                    @if (!string.IsNullOrEmpty(@row["workplace"].ToString()))
                                    {
                                        @row["workplace"]
                                    }
                                </td>
                                <td>@variable</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(row["resultValue"].ToString()))
                                    {
                                        @row["resultValue"]
                                    }
                                    else
                                    {
                                        if (row["resultAttribute"].ToString() == "1")
                                        {
                                            <i class="fa fa-check-circle text-success" title="OK"></i>
                                        }
                                        else
                                        {
                                            <i class="fa fa-times-circle text-danger" title="NOK"></i>
                                        }
                                    }
                                </td>
                                <td>@row["minTolerance"]</td>
                                <td>@row["maxTolerance"]</td>

                                <td>@(stats?.Conteo ?? 0)</td>
                                <td>@(stats?.Defectos ?? 0)</td>
                                <td>@(stats?.Media.ToString("0.00") ?? "-")</td>
                                <td>@(stats?.Sigma.ToString("0.00") ?? "-")</td>
                                <td>@(stats?.Cp.ToString("0.00") ?? "-")</td>
                                <td>@(stats?.Cpk.ToString("0.00") ?? "-")</td>
                            </tr>
                        }
                    }
                }
            </tbody>
        </table>
    }
    else if (Model.Checklist != null)
    {
        <div class="alert alert-warning">No se encontraron checklist para el lote o rango seleccionado.</div>
    }

    @if (Model.Trazabilidad != null && Model.Trazabilidad.Rows.Count > 0)
{
        <h4>Estructura de Lotes (Jerarquía de Trazabilidad)</h4>
        <table class="table table-bordered table-sm">
            <thead>
                <tr>
                    <th>Padre</th>
                    <th>Hijo</th>
                    <th>Lote</th>
                    <th>Identificador</th>
                    <th>Nivel</th>
                </tr>
            </thead>
            <tbody>
                @foreach (System.Data.DataRow row in Model.Trazabilidad.Rows)
                {
                    <tr>
                        <td>@row["Padre"]</td>
                        <td>@row["Hijo"]</td>
                        <td>@row["batch"]</td>
                        <td>@row["batchIdentifier"]</td>
                        <td>@row["Nivel"]</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <button class="btn btn-primary" onclick="window.print()">Imprimir Reporte</button>
</div>

@section Scripts {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

    @if (Model.StartDate.HasValue && Model.EndDate.HasValue)
    {
        <script>
            const rangeSlider = document.getElementById('rangeSlider');
            const displayStart = document.getElementById('displayStart');
            const displayEnd = document.getElementById('displayEnd');
            const inputStart = document.getElementById('startDateInput');
            const inputEnd = document.getElementById('endDateInput');

            const dateStart = new Date("@Model.StartDate.Value.ToString("yyyy-MM-ddTHH:mm:ss")");
            const dateEnd = new Date(dateStart.getTime() + 24 * 60 * 60 * 1000); // Solo para demo

            const totalMs = dateEnd - dateStart;

            function generatePipPositions(totalMs) {
                const positions = [];
                const hourInMs = 60 * 60 * 1000;
                const totalHours = Math.floor(totalMs / hourInMs);
                for (let i = 0; i <= totalHours; i++) {
                    const percent = (i * hourInMs * 100) / totalMs;
                    positions.push(Math.min(percent, 100));
                }
                return positions;
            }

            noUiSlider.create(rangeSlider, {
                start: [0, totalMs],
                connect: true,
                step: 15 * 60 * 1000,
                range: {
                    min: 0,
                    max: totalMs
                },
                format: {
                    to: v => parseInt(v),
                    from: v => parseInt(v)
                },
                tooltips: [
                    {
                        to: v => new Date(dateStart.getTime() + v).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        from: () => 0
                    },
                    {
                        to: v => new Date(dateStart.getTime() + v).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        from: () => 0
                    }
                ],
                pips: {
                    mode: 'positions',
                    values: generatePipPositions(totalMs),
                    density: 2,
                    stepped: true
                }
            });

            rangeSlider.noUiSlider.on('update', function (values) {
                const msStart = parseInt(values[0]);
                const msEnd = parseInt(values[1]);
                const newStart = new Date(dateStart.getTime() + msStart);
                const newEnd = new Date(dateStart.getTime() + msEnd);
                displayStart.textContent = newStart.toLocaleString@Localizer["();"]
                displayEnd.textContent = newEnd.toLocaleString@Localizer["();"]
                inputStart.value = newStart.getFullYear() + '-' +
                    String(newStart.getMonth() + 1).padStart(2, '0') + '-' +
                    String(newStart.getDate()).padStart(2, '0') + 'T' +
                    String(newStart.getHours()).padStart(2, '0') + ':' +
                    String(newStart.getMinutes()).padStart(2, '0');

                inputEnd.value = newEnd.getFullYear() + '-' +
                    String(newEnd.getMonth() + 1).padStart(2, '0') + '-' +
                    String(newEnd.getDate()).padStart(2, '0') + 'T' +
                    String(newEnd.getHours()).padStart(2, '0') + ':' +
                    String(newEnd.getMinutes()).padStart(2, '0');
            });

            rangeSlider.noUiSlider.set([0, totalMs]);
        </script>
    }
}


