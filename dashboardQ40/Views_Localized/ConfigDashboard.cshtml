@model dynamic

@{
    ViewData["Title"] = "Configuración de Dashboards";
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/8.2.0/gridstack.min.css">
 <style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
    }

    .grid-stack {
        width: 100%;
        min-height: 400px;
        border: 1px solid #ddd;
        padding: 10px;
    }

    .widget-container {
        display: flex;
        width: 100%;
        height: 100%;
    }

    .widget-table {
        width: 40%;
        overflow-y: auto;
        border-right: 1px solid #ddd;
        padding: 10px;
    }

    .widget-chart {
        width: 60%;
        height: 100%;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 5px;
        text-align: left;
    }

    th {
        background-color: #f4f4f4;
    }

    td:hover {
        cursor: pointer;
        background-color: #ddd;
    }
    </style>

<h2>Configuración de Dashboards</h2>
<label for="planta">Planta:</label>
<select id="planta">
    <option value="Planta1">Planta 1</option>
    <option value="Planta2">Planta 2</option>
</select>

<label for="linea">Línea:</label>
<select id="linea">
    <option value="Linea1">Línea 1</option>
    <option value="Linea2">Línea 2</option>
</select>

<label for="variableY">Variable Y:</label>
<select id="variableY" onchange="loadVariablesX()">
    <option value="BRIX">BRIX</option>
    <option value="CARBONATACIÓN">CARBONATACIÓN</option>
</select>

<div id="variablesXContainer">
    <h4>Variables X asociadas:</h4>
    <div id="variablesX"></div>
</div>

<button onclick="saveDashboard()">Guardar Dashboard</button>
<div class="grid-stack"></div>

@section Scripts {
    
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/8.2.0/gridstack-all.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            window.grid = GridStack.init@Localizer["();"]
            console.log("✅ GridStack inicializado");
        });

        const variableXMapping = {
            "BRIX": ["FRECUENCIA BOMBA DE AGUA", "FRECUENCIA BOMBA DE JARABE", "FRECUENCIA DE BOMBA DE MEZCLA"],
            "CARBONATACIÓN": ["TEMPERATURA", "PRESIÓN CO2", "POSICIÓN DE MICRO"]
        };

        function loadVariablesX() {
            let variableY = document.getElementById("variableY").value;
            let variablesX = variableXMapping[variableY] || [];
            let variablesXContainer = document.getElementById("variablesX");
            variablesXContainer.innerHTML = "";

            variablesX.forEach(variableX => {
                let button = document.createElement("button");
                button.textContent = "Agregar Widget para " + variableX;
                button.onclick = () => addWidget(variableX);
                variablesXContainer.appendChild(button);
            });
        }

        function addWidget(variableX) {
            console.log("🆕 Agregando widget con tabla y gráfico para:", variableX);
            let widgetId = `widget-${Date.now()}@Localizer["`;"]

            let el = document.createElement('div');
            el.classList.add("grid-stack-item");
            el.setAttribute("data-gs-w", "4");
            el.setAttribute("data-gs-h", "3");
            el.setAttribute("data-widgetid", widgetId);

            el.innerHTML = `
                        <div class="grid-stack-item-content widget-container">
                            <div class="widget-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>${variableX}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="${widgetId}-table">
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="${widgetId}" class="widget-chart"></div>
                        </div>@Localizer["@Localizer["`;"]"]

            grid.addWidget(el);
            console.log("✅ Widget agregado");
            loadTableAndChart(widgetId, variableX);
        }

        function loadTableAndChart(widgetId, variableX) {
            let tableBody = document.getElementById(`${widgetId}-table@Localizer["`);"]
            let chartElement = document.getElementById(widgetId);
            let chart = echarts.init(chartElement);

            let data = [
                { time: "24-01-25 12:00", value: Math.random() * 100 },
                { time: "24-01-25 12:20", value: Math.random() * 100 },
                { time: "24-01-25 12:40", value: Math.random() * 100 }
            ];

            tableBody.innerHTML = "";
            data.forEach((row, index) => {
                let tr = document.createElement("tr");
                tr.innerHTML = `<td>${row.time}</td><td>${row.value.toFixed(2)}</td>@Localizer["@Localizer["`;"]"]
                tr.onclick = () => highlightPoint(chart, index, data);
                tableBody.appendChild(tr);
            });

            let options = {
                xAxis: { type: 'category', data: data.map(d => d.time) },
                yAxis: { type: 'value' },
                series: [{ type: 'line', data: data.map(d => d.value) }]
            };
            chart.setOption(options);
        }

        function highlightPoint(chart, index, data) {
            let updatedData = data.map((d, i) => i === index ? { value: d.value, itemStyle: { color: 'red' } } : d.value);
            chart.setOption({ series: [{ data: updatedData }] });
        }





        function saveDashboard() {
            let widgetsData = [];

            document.querySelectorAll(".grid-stack-item").forEach(widgetEl => {
                let widgetId = widgetEl.getAttribute("data-widgetid");
                let variableX = widgetEl.getAttribute("data-variablex");
                let widgetType = widgetEl.getAttribute("data-widgettype");

                if (!widgetId || !variableX || !widgetType) {
                    console.error("⚠️ Widget con datos faltantes:", widgetEl);
                    return;
                }

                widgetsData.push({
                    VariableX: variableX,
                    WidgetType: widgetType,
                    Position: JSON.stringify({ x: widgetEl.getAttribute("data-gs-x") || 0, y: widgetEl.getAttribute("data-gs-y") || 0, w: 3, h: 2 }),
                    Config: "{}",
                    DataSource: "API"
                });
            });

            if (widgetsData.length === 0) {
                alert("No hay widgets válidos para guardar.");
                return;
            }

            let dashboardData = {
                planta: document.getElementById("planta").value,
                linea: document.getElementById("linea").value,
                variableY: document.getElementById("variableY").value,
                templateName: "Dashboard Configurado",
                widgets: widgetsData
            };

            console.log("📤 Enviando datos al backend:", dashboardData);

            fetch('/api/DashboardTemplates/admin/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dashboardData)
            })
                .then(response => response.json())
                .then(data => console.log("✅ Dashboard guardado:", data))
                .catch(error => console.error("❌ Error al guardar:", error));
        }






    </script>
}
