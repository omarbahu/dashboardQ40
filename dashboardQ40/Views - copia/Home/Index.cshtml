@{
    ViewData["Title"] = "Dashboard Calidad";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-semibold text-dark mb-0">Dashboard Ejecutivo de Calidad</h4>

        <div class="d-flex gap-2">
            <select id="vistaSelector" class="form-select form-select-sm">
                <option value="global">🌎 Global</option>
                <option value="regional">📍 Regional</option>
                <option value="planta">🏭 Planta</option>
            </select>

            <select id="paisSelector" class="form-select form-select-sm" style="display: none;"></select>

            <select id="plantaSelector" class="form-select form-select-sm" style="display: none;"></select>

            <select id="variableSelector" class="form-select form-select-sm">
                <option value="brix">Brix</option>
                <option value="co2">CO2</option>
                <option value="net">Net</option>
                <option value="torque">Torque</option>
            </select>
        </div>
    </div>

    <div id="contenidoDashboard"></div>
</div>

@{
    var dashboardUrl = Url.Action("Index", "Dashboard");
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script>
        /*

        function getUserFromCaptorCookie() {
            const isLocal = location.hostname === "localhost";

            let cookieValor = "";

            if (isLocal) {
                // Modo desarrollo: definir cookie simulada
                const simulada = "UserName=captor&Company=001";
                const nombre = "LogonData_localhost_CaptorArca";
                document.cookie = nombre + "=" + encodeURIComponent(simulada) + "; path=/;";
                cookieValor = simulada;
            } else {
                // Modo producción: buscar cookie real de Captor
                const cookies = document.cookie.split("; ");
                const captorCookie = cookies.find(c => c.startsWith("LogonData_") && c.includes("CaptorArca"));
                if (!captorCookie) return null;

                const encoded = captorCookie.split("=")[1];
                cookieValor = decodeURIComponent(encoded);
            }

            // Extraer datos de la cookie
            const userMatch = cookieValor.match(/UserName=([^&]*)/);
            const companyMatch = cookieValor.match(/Company=([^&]*)/);

            const user = userMatch ? userMatch[1] : null;
            const company = companyMatch ? companyMatch[1] : null;

            return { user, company };
        }

        // Uso:
        const datos = getUserFromCaptorCookie();
        if (datos) {
            console.log("Usuario:", datos.user);
            console.log("Empresa:", datos.company);
            $.ajax({
                url: '@Url.Action("ValidarUsuario", "Auth")',
                type: 'GET',
                data: {
                    user: datos.user,
                    company: datos.company
                },
                success: function (data) {
                    if (data.autorizado) {
                        console.log("✅ Usuario autorizado:", data.usuario, data.nombre);
                    } else {
                        window.location.href = "/Home/NoAutorizado";
                    }
                },
                error: function () {
                    alert("Error al validar el usuario.");
                    window.location.href = "/Home/NoAutorizado";
                }
            });
        } else {
            console.log("❌ No se encontró la cookie válida.");
        }

        */

        const plantasPorPais = {
            "Mexico": ["Insurgentes", "favorita", "mexicali", "guadalupe", "chihuahua", "aguascalientes", "san agustin", "culiacan", "topo-chico", "juarez", "hermosillo", "san luis potosi", "matamoros", "durango", "piedras negras", "la paz", "saltillo", "zapopan", "trojes"],
            "Peru": ["pucusana", "zarate", "trujillo", "arequipa", "cusco", "iquitos"],
            "Ecuador": ["guayaquil", "quito", "santo domingo"],
            "Argentina": ["salta", "tucuman", "formosa"],
            "USA": ["north point", "mcallen", "el paso", "san antonio", "abilene", "forth worth", "oklahoma"]
        };

        const dashboardUrl = '@dashboardUrl';

        $(document).ready(function () {
            // Llenar selector de país al cargar
            const $paisSelector = $('#paisSelector');
            Object.keys(plantasPorPais).forEach(pais => {
                $paisSelector.append(`<option value="${pais}">${pais}</option>`);
            });

            function actualizarPlantas(pais) {
                const plantas = plantasPorPais[pais] || [];
                const $plantaSelector = $('#plantaSelector');
                $plantaSelector.empty();
                plantas.forEach(p => $plantaSelector.append(`<option value="${p}">${p}</option>`));
            }

            function renderizarDashboard() {
                const vista = $('#vistaSelector').val();
                const pais = $('#paisSelector').val();
                const planta = $('#plantaSelector').val();
                const variable = $('#variableSelector').val();

                let html = '';

                if (vista === 'global') {
                    html += `<div class='row g-3 mb-3'>`;
                    Object.keys(plantasPorPais).forEach(pais => {
                        html += `<div class='col-md-3'>
                                    <div class='card shadow-sm border-0'>
                                        <div class='card-body'>
                                            <h6 class='text-muted'>${pais}</h6>
                                            <h5 class='fw-bold text-danger'>&mu;: ${(Math.random() * 10 + 10).toFixed(2)}</h5>
                                            <p class='mb-0 small text-muted'>Cp: ${(Math.random() * 2).toFixed(2)} | Cpk: ${(Math.random() * 2).toFixed(2)}</p>
                                        </div>
                                    </div>
                                </div>`;
                    });
                    html += `</div><div class="card shadow-sm border-0">
                                <div class="card-body">
                                    <h6 class="text-muted">Cpk por país - ${variable.toUpperCase()}</h6>
                                    <div id="chartGlobal" style="height: 300px;"></div>
                                </div>
                            </div>`;
                }
                else if (vista === 'regional' && pais && plantasPorPais[pais]) {
                    html += `<div class='row g-3 mb-3'>`;
                    plantasPorPais[pais].forEach(planta => {
                        let dashboardLink = '';
                        if (pais === "Mexico" && planta.toLowerCase() === "insurgentes") {
                            dashboardLink = `<a href="${dashboardUrl}" class="btn btn-outline-danger btn-sm mt-2 w-100" target="_blank">
                                <i class="fas fa-chart-line me-1"></i> Ver Dashboard
                             </a>`;
                        }

                        html += `<div class='col-md-3'>
                <div class='card shadow-sm border-0'>
                    <div class='card-body'>
                        <h6 class='text-muted'>${planta}</h6>
                        <h5 class='fw-bold text-danger'>&mu;: ${(Math.random() * 10 + 10).toFixed(2)}</h5>
                        <p class='mb-0 small text-muted'>Cp: ${(Math.random() * 2).toFixed(2)} | Cpk: ${(Math.random() * 2).toFixed(2)}</p>
                        ${dashboardLink}
                    </div>
                </div>
            </div>`;
                    });
                    html += `</div><div class="card shadow-sm border-0">
                                <div class="card-body">
                                    <h6 class="text-muted">Cpk por planta - ${pais}</h6>
                                    <div id="chartRegional" style="height: 300px;"></div>
                                </div>
                            </div>`;
                }
                else if (vista === 'planta') {
                    const lineas = [1, 2, 3, 4].map(i => {
                        return {
                            linea: `Línea 0${i}`,
                            mu: (Math.random() * 10 + 10).toFixed(2),
                            cp: (Math.random() * 2).toFixed(2),
                            cpk: (Math.random() * 2).toFixed(2)
                        };
                    });

                    html += `<div class='card shadow-sm border-0 mb-3'>
                                <div class='card-body'>
                                    <h6 class='text-muted mb-3'>Indicadores de Planta: <strong>${planta}</strong></h6>
                                    <div class="row g-3">
                                        ${lineas.map(l => `
                                            <div class="col-md-3">
                                                <div class="border rounded p-3 h-100 bg-light">
                                                    <h6 class="text-muted mb-1">${l.linea}</h6>
                                                    <p class="mb-0 fw-semibold text-danger">&mu;: ${l.mu}</p>
                                                    <small class="text-muted">Cp: ${l.cp} | Cpk: ${l.cpk}</small>
                                                </div>
                                            </div>`).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="card shadow-sm border-0">
                                <div class="card-body">
                                    <h6 class="text-muted">Cpk por línea - ${planta}</h6>
                                    <div id="chartPlanta" style="height: 300px;"></div>
                                </div>
                            </div>`;

                    $('#contenidoDashboard').html(html);

                    const chart = echarts.init(document.getElementById('chartPlanta'));
                    chart.setOption({
                        xAxis: { type: 'category', data: lineas.map(l => l.linea) },
                        yAxis: { type: 'value' },
                        series: [{
                            type: 'bar',
                            data: lineas.map(l => l.cpk),
                            itemStyle: { color: '#b31217' }
                        }]
                    });
                    return;
                }

                $('#contenidoDashboard').html(html);

                if (vista === 'global') {
                    const chart = echarts.init(document.getElementById('chartGlobal'));
                    chart.setOption({
                        xAxis: { type: 'category', data: Object.keys(plantasPorPais) },
                        yAxis: { type: 'value' },
                        series: [{
                            type: 'bar',
                            data: Object.keys(plantasPorPais).map(_ => (Math.random() * 2).toFixed(2)),
                            itemStyle: { color: '#b31217' }
                        }]
                    });
                }
                else if (vista === 'regional') {
                    const plantas = plantasPorPais[pais];
                    const chart = echarts.init(document.getElementById('chartRegional'));
                    chart.setOption({
                        xAxis: { type: 'category', data: plantas },
                        yAxis: { type: 'value' },
                        series: [{
                            type: 'bar',
                            data: plantas.map(_ => (Math.random() * 2).toFixed(2)),
                            itemStyle: { color: '#b31217' }
                        }]
                    });
                }
            }

            // Eventos
            $('#vistaSelector').on('change', function () {
                const vista = $(this).val();
                $('#paisSelector').toggle(vista !== 'global');
                $('#plantaSelector').toggle(vista === 'planta');
                if (vista !== 'global') actualizarPlantas($('#paisSelector').val());
                renderizarDashboard();
            });

            $('#paisSelector').on('change', function () {
                actualizarPlantas(this.value);
                renderizarDashboard();
            });

            $('#plantaSelector, #variableSelector').on('change', renderizarDashboard);

            // Inicialización
            const primerPais = Object.keys(plantasPorPais)[0];
            $('#paisSelector').val(primerPais);
            actualizarPlantas(primerPais);
            renderizarDashboard();
        });
    </script>
}
