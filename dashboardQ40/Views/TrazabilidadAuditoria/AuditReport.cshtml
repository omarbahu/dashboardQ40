@model FormatoViewModel
@{
    ViewData["Title"] = Localizer["TraceDetail_Title"];
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@inject IStringLocalizer Localizer

<style>
    .traza-bloque {
        border-collapse: collapse;
        width: 100%;
        font-size: 12px;
        table-layout: fixed;
    }

        .traza-bloque th, .traza-bloque td {
            border: 1px solid #666;
            padding: 4px;
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }

        .traza-bloque th {
            background-color: #cfe2f3;
            font-weight: bold;
        }

    .titulo-reporte {
        text-align: center;
        font-size: 14px;
        font-weight: bold;
        padding: 8px;
        background-color: #fff2cc;
        border: 1px solid #666;
    }

    .encabezado-subtitulo {
        font-weight: bold;
        background-color: #daeef3;
    }

    details {
        margin-bottom: 10px;
        border: 1px solid #ccc;
        padding: 5px;
    }

    summary {
        font-weight: bold;
        cursor: pointer;
        padding: 5px;
        background-color: #e2f0d9;
        border-bottom: 1px solid #ccc;
    }


    .tabla-trazabilidad {
        border-collapse: collapse;
        width: 100%;
        font-size: 13px;
        font-family: sans-serif;
    }

        .tabla-trazabilidad th,
        .tabla-trazabilidad td {
            border: 1px solid #333;
            padding: 4px;
            text-align: center;
            vertical-align: middle;
        }

    .bg-header {
        background-color: #d9edf7;
        font-weight: bold;
    }

    .bg-subheader {
        background-color: #c6e2f7;
        font-weight: bold;
    }

    .bg-label {
        background-color: #f2f2f2;
        font-weight: bold;
        text-align: left;
        padding-left: 6px;
    }
</style>

<div class="container-fluid mt-4 px-4">
    <table class="traza-bloque">
        <tr>
            <td rowspan="2">
                <img src="/img/logo arca contal.png" alt="@Localizer["Common_LogoAlt"]" height="40" />
            </td>
            <td colspan="5" class="titulo-reporte">@Localizer["TraceDetail_Header_PlantName"]</td>
            <td rowspan="2" class="encabezado-subtitulo">
                @Localizer["TraceDetail_Header_Edition"]:<br>@Localizer["TraceDetail_Header_EditionDate"]
            </td>
        </tr>
        <tr>
            <td colspan="5" style="text-align:center;">
                @Localizer["TraceDetail_Header_CodeAndTitle"]
            </td>
        </tr>
        <tr>
            <th>@Localizer["TraceDetail_Table_Date"]</th>
            <th>@Localizer["TraceDetail_Table_StartTime"]</th>
            <th>@Localizer["TraceDetail_Table_EndTime"]</th>
            <th>@Localizer["TraceDetail_Table_TotalTime"]</th>
            <th>@Localizer["TraceDetail_Table_Reason"]</th>
            <th>@Localizer["TraceDetail_Table_AppliesWithdrawal"]</th>
            <th>@Localizer["TraceDetail_Table_WithdrawalEfficiency"]</th>
        </tr>
        <tr>
            <td>@Localizer["TraceDetail_Sample_Date"]</td>
            <td>@Localizer["TraceDetail_Sample_Start"]</td>
            <td>@Localizer["TraceDetail_Sample_End"]</td>
            <td>@Localizer["TraceDetail_Sample_Total"]</td>
            <td>@Localizer["TraceDetail_Sample_Reason"]</td>
            <td>@Localizer["Common_Yes"]</td>
            <td>@Localizer["TraceDetail_Sample_Efficiency"]</td>
        </tr>
    </table>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs" id="trazabilidadTabs" role="tablist">
        @{
            var secciones = new[] {
        Localizer["TraceTabs_Format"].ToString(),
        Localizer["TraceTabs_RawMaterials"].ToString(),
        Localizer["TraceTabs_Syrups"].ToString(),
        Localizer["TraceTabs_Bottling"].ToString(),
        Localizer["TraceTabs_WaterTreatment"].ToString(),
        Localizer["TraceTabs_Production"].ToString(),
        Localizer["TraceTabs_Cleaning"].ToString()
        };
            for (int i = 0; i < secciones.Length; i++)
            {
                var sec = secciones[i];
                var tabId = sec.Replace(" ", "").ToLower();
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(i == 0 ? "active" : "")"
                            id="@tabId-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#@tabId"
                            type="button"
                            role="tab">
                        @sec
                    </button>
                </li>
            }
        }
    </ul>

    <!-- Tab panes -->
    <div class="tab-content mt-3">
        @{
            for (int i = 0; i < secciones.Length; i++)
            {
                var sec = secciones[i];
                var tabId = sec.Replace(" ", "").ToLower();

                string partialViewName = sec switch
                {
                    var s when s == Localizer["TraceTabs_RawMaterials"] => "~/Views/TrazabilidadAuditoria/Partials/_TabMP.cshtml",
                    var s when s == Localizer["TraceTabs_Syrups"] => "~/Views/TrazabilidadAuditoria/Partials/_TabJarabes.cshtml",
                    var s when s == Localizer["TraceTabs_Format"] => "~/Views/TrazabilidadAuditoria/Partials/_TabFormato.cshtml",
                    var s when s == Localizer["TraceTabs_Bottling"] => "~/Views/TrazabilidadAuditoria/Partials/_TabEmbotellado.cshtml",
                    var s when s == Localizer["TraceTabs_WaterTreatment"] => "~/Views/TrazabilidadAuditoria/Partials/_TabAgua.cshtml",
                    var s when s == Localizer["TraceTabs_Production"] => "~/Views/TrazabilidadAuditoria/Partials/_TabProduccion.cshtml",
                    var s when s == Localizer["TraceTabs_Cleaning"] => "~/Views/TrazabilidadAuditoria/Partials/_TabLimpieza.cshtml",
                    _ => "~/Views/TrazabilidadAuditoria/Partials/_TabFormato.cshtml"
                };
                <div class="tab-pane fade @(i == 0 ? "show active" : "")" id="@tabId" role="tabpanel">
                    <div id="collapse-@tabId" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            @await Html.PartialAsync(partialViewName, Model)
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Abre SOLO el pane del tab activo
            const activePane = document.querySelector('.tab-pane.active');
            document.querySelectorAll('.tab-pane .accordion-collapse').forEach(el => el.classList.remove('show'));
            activePane?.querySelector('.accordion-collapse')?.classList.add('show');

            // Al cambiar de tab, cierra todos y abre el del tab mostrado
            const tabs = document.querySelectorAll('#trazabilidadTabs button[data-bs-toggle="tab"]');
            tabs.forEach(btn => {
                btn.addEventListener('shown.bs.tab', (e) => {
                    document.querySelectorAll('.tab-pane .accordion-collapse').forEach(el => el.classList.remove('show'));
                    const targetPane = document.querySelector(e.target.getAttribute('data-bs-target'));
                    targetPane?.querySelector('.accordion-collapse')?.classList.add('show');
                });

                // Fallback si por algo no está Bootstrap JS: al hacer click
                btn.addEventListener('click', (e) => {
                    setTimeout(() => {
                        const targetPane = document.querySelector(e.target.getAttribute('data-bs-target'));
                        if (!targetPane) return;
                        document.querySelectorAll('.tab-pane .accordion-collapse').forEach(el => el.classList.remove('show'));
                        targetPane.querySelector('.accordion-collapse')?.classList.add('show');
                    }, 0);
                });
            });
        });
    </script>
}


