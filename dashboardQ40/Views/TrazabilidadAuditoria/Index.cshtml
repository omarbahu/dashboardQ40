@inject Microsoft.Extensions.Localization.IStringLocalizer Localizer
@{
    ViewData["Title"] = "Trazabilidad para auditoría";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container mt-5">
    <h2 class="text-center mb-4">@Localizer["AuditTraceability_Title"]</h2>

    <!-- Sección de selección -->
    <div id="opcionesIniciales" class="text-center">
        <button class="btn btn-lg btn-primary m-3" onclick="mostrarFormulario('nuevo')">
            📝 @Localizer["AuditTraceability_CreateNewReport"]
        </button>
        <button class="btn btn-lg btn-secondary m-3" onclick="mostrarFormulario('ver')">
            📂 @Localizer["AuditTraceability_ViewPreviousReports"]
        </button>
    </div>

    <!-- Formulario nuevo reporte -->
    <div id="formNuevo" style="display:none;">
        <div class="card p-4">
            <h4>📄 @Localizer["AuditTraceability_NewReportTitle"]</h4>
            <hr />
            <form id="formGuardar">
                <div class="row">
                <!-- País / Planta -->
                    <div class="col">
                        <label for="pais" class="form-label">@Localizer["XR_Country"]</label>
                    </div>
                    <div class="col">
                        <select id="pais" class="form-select form-select-sm" required>
                            <option value="">-- Selecciona --</option>
                            @foreach (var p in ViewBag.Countries)
                            {
                                <option value="@p.Code">@p.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col">
                        <label for="planta" class="form-label">@Localizer["XR_Plant"]</label>
                    </div>
                    <div class="col">
                        <select id="planta" class="form-select form-select-sm" required disabled>
                            <option value="">-- Selecciona --</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="fechaHora">@Localizer["AuditTraceability_ReportDateTime_Label"]</label>
                        <input type="datetime-local" class="form-control" id="fechaHora" name="FechaHora" value="2025-07-12T09:00" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="horaInicio">@Localizer["Common_StartTime"]</label>
                        <input type="time" class="form-control" id="horaInicio" name="HoraInicio" value="09:00" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="horaFin">@Localizer["Common_EndTime"]</label>
                        <input type="time" class="form-control" id="horaFin" name="HoraFin" value="10:00" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="revision">@Localizer["Common_Revision"]</label>
                        <input type="text" class="form-control" id="revision" name="Revision" value="Rev. 1" />
                    </div>
                </div>

                <div class="mb-3">
                    <label for="motivo">@Localizer["AuditTraceability_Reason_Label"]</label>
                    <textarea class="form-control" id="motivo" name="motivo" rows="2"
                              placeholder="@Localizer["AuditTraceability_Reason_Placeholder"]"></textarea>
                </div>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="lote">@Localizer["Common_Batch"]</label>
                        <input type="text" class="form-control" id="lote" name="Lote" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="horaQueja">@Localizer["AuditTraceability_ComplaintTime"]</label>
                        <input type="time" id="horaQueja" name="horaQueja" class="form-control" value="09:30" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="usuarioVobo">@Localizer["Common_ApprovalUser"]</label>
                        <input type="text" class="form-control" id="usuarioVobo" name="UsuarioVobo" value="Juan Pérez" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="efic">@Localizer["AuditTraceability_FG_EfficiencyPct"]</label>
                        <input type="number" class="form-control" id="efic" name="PorcEficProductoTerminado" value="95.5" />
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" value="1" id="trazaProducto" />
                    <label class="form-check-label" for="trazaProducto">
                        @Localizer["AuditTraceability_RequireRMTraceability_Question"]
                    </label>
                </div>
                <input type="hidden" name="simulate" id="simulate" value="false" />
                <div class="text-end">
                    <button type="submit" class="btn btn-success">@Localizer["Common_Save"]</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="regresar()">
                        @Localizer["Common_Cancel"]
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sección de historial (placeholder) -->
    <div id="formHistorial" style="display:none;">
        <div class="card p-4">
            <h4>📂 @Localizer["AuditTraceability_PreviousReportsTitle"]</h4>
            <p class="text-muted">@Localizer["AuditTraceability_PreviousReportsDesc"]</p>
            <!-- Aquí irá la tabla de historial más adelante -->
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div id="global-loader"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background-color:rgba(0,0,0,0.4); z-index:1040; align-items:center; justify-content:center; flex-direction:column;">
    <div class="spinner-border text-light" style="width:4rem;height:4rem" role="status">
        <span class="visually-hidden">@Localizer["Common_Loading"]</span>
    </div>
    <div class="mt-3 text-white fw-bold text-center" id="mensaje-loader">
        @Localizer["Loader_GeneratingReport"]<br />
        @Localizer["Loader_LoadingBlocks_PleaseWait"]
    </div>
</div>

@section Scripts {
    <!-- Incluye SweetAlert2 si no lo tienes aún -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Etiquetas (puedes cambiarlas o usar Localizer)
        const LABELS = {
            Select: "-- Selecciona --",
            Line: "@Localizer["XR_Line"]",
            Plant: "@Localizer["XR_Plant"]"
        };

        // Todas las companies (Company, CompanyName, CountryCode) desde backend
        window.COMPANIES = @Html.Raw(ViewBag.CompaniesJson ?? "[]");

        // Helpers
        function toArray(data) {
            if (!data) return [];
            if (Array.isArray(data)) return data;
            if (Array.isArray(data.$values)) return data.$values;
            if (Array.isArray(data.value?.$values)) return data.value.$values;
            if (Array.isArray(data.value)) return data.value;
            return [];
        }
        function resetSelect($el, placeholder) {
            $el.empty().append(new Option(placeholder, ""));
        }

        // 1) País → cargar Plantas
        function fillPlants(countryCode) {
            const $planta = $("#planta");
            resetSelect($planta, LABELS.Plant);
            $planta.prop("disabled", true);

            if (!countryCode) return;

            const plants = COMPANIES
                .filter(c => c.CountryCode === countryCode)
                .sort((a, b) => a.CompanyName.localeCompare(b.CompanyName, 'es'));

            plants.forEach(p => $planta.append(new Option(p.CompanyName, p.Company)));
            $planta.prop("disabled", plants.length === 0);
        }
        $("#pais").on("change", function () { fillPlants(this.value); });


        // Init opcional: seleccionar el primer país y disparar el llenado
        $(function () {
            const $pais = $("#pais");
            if ($pais[0] && $pais[0].options.length > 1) {
                $pais[0].selectedIndex = 1;
                $pais.trigger("change");
            }
        });

        function validarPaisPlanta() {
            const pais = $("#pais").val();
            const planta = $("#planta").val();

            if (!pais) {
                Swal.fire({ icon: "warning", title: "Selecciona el país", text: "Debes elegir un país." });
                $("#pais").focus();
                return false;
            }
            if (!planta) {
                Swal.fire({ icon: "warning", title: "Selecciona la planta", text: "Debes elegir una planta." });
                $("#planta").focus();
                return false;
            }
            return true;
        }


        // Diccionario JS desde Localizer
        const T = {
            Blocks: [
                "@Localizer["Block_RawMaterials"]",
                "@Localizer["Block_FinishedProduct"]",
                "@Localizer["Block_TimeLog"]",
                "@Localizer["Block_SyrupsInfo"]",
                "@Localizer["Block_SensoryRelease"]",
                "@Localizer["Block_CleaningChecklist"]",
                "@Localizer["Block_ProcessData"]"
            ],
            LoaderGenerating: "@Localizer["Loader_GeneratingReport"]",
            LoaderLoadingBlock: "@Localizer["Loader_LoadingBlock"]",
            LoaderReportReady: "@Localizer["Loader_ReportReadyRedirect"]",
            ErrorUnexpected: "@Localizer["Common_ErrorUnexpected"]",
            ErrorSaving: "@Localizer["Common_ErrorSaving"]"
        };

        let intervaloBloques;

        function iniciarAnimacionBloques() {
            let i = 0;
            const loader = $("#mensaje-loader");
            loader.html(T.LoaderGenerating + "<br/>");
            intervaloBloques = setInterval(() => {
                loader.html(`${T.LoaderGenerating}<br/>${T.LoaderLoadingBlock} ${T.Blocks[i % T.Blocks.length]}...`);
                i++;
            }, 1500);
        }

        function detenerAnimacionBloques() {
            clearInterval(intervaloBloques);
            $("#mensaje-loader").html(T.LoaderReportReady);
        }

        $(document).ready(function () {
            $("#global-loader").fadeOut();
        });

        function mostrarFormulario(tipo) {
            document.getElementById("opcionesIniciales").style.display = "none";

            if (tipo === 'nuevo') {
                document.getElementById("formNuevo").style.display = "block";
            } else if (tipo === 'ver') {
                document.getElementById("formHistorial").style.display = "block";

                if (!_historialCargado) {
                    document.getElementById('global-loader')?.classList.remove('d-none');
                    const url = '@Url.Action("HistorialPartial", "TrazabilidadAuditoria")';
                    $("#formHistorial").load(url, function () {
                        _historialCargado = true;
                        document.getElementById('global-loader')?.classList.add('d-none');
                        if (window.initHistorial) window.initHistorial(); // dentro valida la planta
                    });
                } else {
                    if (window.cargarHistorial) window.cargarHistorial(); // ya valida planta internamente
                }
            }
        }


        function regresar() {
            document.getElementById("formNuevo").style.display = "none";
            document.getElementById("formHistorial").style.display = "none";
            document.getElementById("opcionesIniciales").style.display = "block";
        }

        $("#formGuardar").submit(async function (e) {
            e.preventDefault();
            if (!validarPaisPlanta()) return;
            const result = await Swal.fire({
                title: '¿Cómo deseas proceder?',
                text: 'Puedes guardar el reporte o ejecutar una simulación (no escribirá en la BD).',
                icon: 'question',
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                denyButtonText: 'Simulación',
                cancelButtonText: 'Cancelar'
            });

            // Si canceló, no sigas y asegúrate de ocultar loader si estuviera visible
            if (result.isDismissed && !result.isConfirmed && !result.isDenied) {
                detenerAnimacionBloques();
                $("#global-loader").hide();
                return;
            }

            const data = {
                country: $("#pais").val(),             
                company: $("#planta").val(),           
                FechaHora: $("#fechaHora").val(),
                HoraInicio: $("#horaInicio").val(),
                HoraFin: $("#horaFin").val(),
                MotivoTrazabilidad: $("#motivo").val(),
                TrazaProductoMp: $("#trazaProducto").is(":checked"),
                PorcEficProductoTerminado: parseFloat($("#efic").val()) || 0,
                Lote: $("#lote").val(),
                Revision: $("#revision").val(),
                UsuarioVobo: $("#usuarioVobo").val(),
                horaQueja: $("#horaQueja").val(),
                simulate: result.isDenied // Guardar=false, Simulación=true
            };

            $("#mensaje-loader").html(T.LoaderGenerating + "<br/>");
            $("#global-loader").css('display', 'flex');

            $.ajax({
                url: '@Url.Action("GuardarReporte", "TrazabilidadAuditoria")',
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                data: JSON.stringify(data),

                success: async function (res) {
                    // Oculta el overlay ANTES del Swal
                    //detenerAnimacionBloques();
                    $("#global-loader").hide();

                    if (res && res.success) {
                        if (data.simulate) {
                            await Swal.fire({
                                icon: 'info',
                                title: 'Simulación realizada',
                                text: 'No se guardó en la base de datos.',
                                confirmButtonText: 'Entendido'
                            });
                        } else {
                            await Swal.fire({
                                icon: 'success',
                                title: 'Guardado',
                                text: 'Reporte guardado correctamente.',
                                confirmButtonText: 'Continuar'
                            });
                        }
                        $("#mensaje-loader").html(
                            `<b>${T.LoaderGenerating}</b><br/>${T.LoaderLoadingBlock} ${T.Blocks[0]}...`
                        );
                        iniciarAnimacionBloques();
                        $("#global-loader").css("display", "flex");
                        await new Promise(r => setTimeout(r, 300));
                        // Redirección
                        $("#formGuardar")[0].reset();
                        window.location.href =
                            '/TrazabilidadAuditoria/AuditReport?lote=' +
                            encodeURIComponent(data.Lote) +
                            '&horaQueja=' + encodeURIComponent(data.horaQueja) +
                            '&company=' + encodeURIComponent(data.company);
                    } else {
                        alert("❌ " + T.ErrorUnexpected);
                    }
                },

                error: function (err) {
                    console.error(err);
                    alert("❌ " + T.ErrorSaving);
                },

                complete: function () {
                    //detenerAnimacionBloques();
                    $("#global-loader").hide(); // pase lo que pase, apágalo
                }
            });
        });

        function setInvalid($el, invalid) {
            $el.toggleClass("is-invalid", invalid);
        }



        let _historialCargado = false;

        function mostrarFormulario(tipo) {
            document.getElementById("opcionesIniciales").style.display = "none";

            if (tipo === 'nuevo') {
                document.getElementById("formNuevo").style.display = "block";
            } else if (tipo === 'ver') {
                document.getElementById("formHistorial").style.display = "block";

                if (!_historialCargado) {
                    document.getElementById('global-loader')?.classList.remove('d-none');
                    const url = '@Url.Action("HistorialPartial", "TrazabilidadAuditoria")';
                    $("#formHistorial").load(url, function () {
                        _historialCargado = true;
                        document.getElementById('global-loader')?.classList.add('d-none');
                        if (window.initHistorial) window.initHistorial();
                    });
                } else {
                    // 🔹 recarga el grid con el company (planta) actual
                    if (window.cargarHistorial) window.cargarHistorial();
                }
            }
        }


        // (Opcional) Volver al inicio desde cualquier sección:
        window.volverOpciones = function () {
            $("#formNuevo, #formHistorial").hide();
            $("#opcionesIniciales").show();
        }
    </script>
}
