@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    @inject Microsoft.Extensions.Localization.IStringLocalizer Localizer
}

@{
    var y = DateTime.Today.Year;
    var startDef = new DateTime(y, 10, 11);   // 1 mayo
    var endDef = new DateTime(y, 8, 30);  // 30 junio
}

<style>
#loaderOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.loaderContent {
    text-align: center;
}

.bubbles {
    width: 50px;
    height: 50px;
    margin: auto;
    position: relative;
}

.bubbles::before,
.bubbles::after {
    content: "";
    position: absolute;
    border-radius: 50%;
    animation: bubble 1s infinite ease-in-out;
}

.bubbles::before {
    width: 20px;
    height: 20px;
    background-color: #e11d48;
    left: 0;
}

.bubbles::after {
    width: 20px;
    height: 20px;
    background-color: #0284c7;
    right: 0;
    animation-delay: 0.5s;
}

@@keyframes bubble {
    0%, 100% {
        transform: translateY(0);
        opacity: 0.7;
    }
    50% {
        transform: translateY(-15px);
        opacity: 1;
    }
}

.loaderText {
    margin-top: 10px;
    font-size: 1rem;
    color: #333;
    font-weight: 500;
}
</style>
<form id="selectionForm" target="_blank">
    <div class="row row-cols-lg-auto g-2 align-items-end">
        <div class="col">
            <label for="startDate" class="form-label">@Localizer["From"]</label>
        </div>
        <div class="col">
            <input type="date"
                   id="startDate"
                   name="startDate"
                   class="form-control form-control-sm"
                   value="@startDef.ToString("yyyy-MM-dd")" />
        </div>


        <!-- País / Planta -->
        <div class="col">
            <label for="pais" class="form-label">@Localizer["XR_Country"]</label>
        </div>
        <div class="col">
            <select id="pais" class="form-select form-select-sm">
                <option value="">-- Selecciona --</option>
                @foreach (var p in ViewBag.Countries)
                {
                    <option value="@p.Code">@p.Name</option>
                }
            </select>
        </div>

        <div class="col">
            <label for="planta" class="form-label">@Localizer["XR_Plant"]</label>
        </div>
        <div class="col">
            <select id="planta" name="planta" class="form-select form-select-sm">
                <option value="">-- Selecciona --</option>
            </select>
        </div>

        <!-- Puesto (antes Línea) -->
        <div class="col">
            <label for="workplace" class="form-label">Puesto</label>
        </div>
        <div class="col">
            <select id="workplace" name="workplace" class="form-select form-select-sm">
                <option value="">-- Selecciona --</option>
            </select>
        </div>


        <div class="col">
            <button id="btnBuscar" type="button" class="btn btn-primary btn-sm">Buscar</button>
        </div>
        <div class="col">
            <button id="btnExport" type="button" class="btn btn-success btn-sm">Exportar Excel</button>
        </div>
    </div>

    <!-- Carga masiva en una tarjeta aparte, centrada -->
    <div class="row mt-4">
        <div class="col-12 col-lg-8 col-xl-6 mx-auto">
            <div class="border rounded p-3 shadow-sm">
                <h5 class="mb-3">Carga masiva de autocontroles</h5>

                <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-8">
                        <label for="fileACs" class="form-label mb-1">
                            Seleccionar archivo Excel (.xlsx)
                        </label>
                        <input type="file"
                               id="fileACs"
                               name="file"
                               class="form-control"
                               accept=".xlsx,.xls" />
                    </div>

                    <div class="col-12 col-md-4 text-md-end">
                        <button type="button"
                                class="btn btn-primary mt-2 mt-md-0"
                                onclick="importarExcelACs()">
                            Importar Excel
                        </button>
                    </div>
                </div>

                <div id="importResult" class="mt-3 small text-muted"></div>
            </div>
        </div>
    </div>
</form>

<div id="loaderOverlay">
    <div class="loaderContent">
        <div class="bubbles"></div>
        <p class="loaderText">Loading</p>
    </div>
</div>

<hr />
<div id="gridWrap" class="table-responsive" style="display:none">
    <table id="gridAC" class="table table-sm table-striped">
        <thead></thead>
        <tbody></tbody>
    </table>
    <div id="gridCount" class="mt-2 text-muted"></div>
</div>



@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

    <script>
        // --- helpers mínimos ---
        function resetSelect($el, placeholder) { $el.empty().append(new Option(placeholder || "-- Selecciona --", "")); }

        function toArray(data) {
            if (!data) return [];
            if (Array.isArray(data)) return data;
            if (Array.isArray(data.$values)) return data.$values;
            if (Array.isArray(data.value?.$values)) return data.value.$values;
            if (Array.isArray(data.value)) return data.value;
            if (Array.isArray(data.rows)) return data.rows;
            if (Array.isArray(data.rows?.$values)) return data.rows.$values;
            return [];
        }

        // --- combos País/Planta/Línea ---
        const COMPANIES = @Html.Raw(ViewBag.CompaniesJson ?? "[]");
        const LABELS = {
            Select: "-- Selecciona --",
            Workplace: "Puesto",
            Plant: "@Localizer["XR_Plant"]"
        };

        function fillPlants(countryCode) {
            const $planta = $("#planta");
            resetSelect($planta, LABELS.Plant);
            resetSelect($("#workplace"), LABELS.Workplace);
            if (!countryCode) return;

            const plants = COMPANIES
                .filter(c => c.CountryCode === countryCode)
                .sort((a, b) => a.CompanyName.localeCompare(b.CompanyName, 'es'));

            plants.forEach(p => $planta.append(new Option(p.CompanyName, p.Company)));
        }


        function loadWorkplacesByCompany(companyId) {
            const $workplace = $("#workplace");
            resetSelect($workplace, LABELS.Workplace);
            if (!companyId) return;

            $.ajax({
                url: '@Url.Action("ObtenerWorkplaces", "CargaACs")', // mismo endpoint, solo cambiamos el combo
                type: 'GET',
                data: { company: companyId },
                success: function (data) {
                    const lines = toArray(data).sort((a, b) => (a.workplaceName || a.name || '')
                        .localeCompare((b.workplaceName || b.name || ''), 'es'));

                    lines.forEach(l => {
                        const id = l.workplace ?? l.id;
                        const name = l.workplaceName ?? l.name ?? id;
                        $workplace.append(new Option(name, id));
                    });
                },
                error: function (xhr) { console.error("ObtenerLineas error", xhr); }
            });
        }


        // --- payload para consulta ---
        function getPayload() {
            const company = $("#planta").val() || null;
            const workplace = $("#workplace").val() || null;
            const date = $("#startDate").val() || null; // yyyy-MM-dd

            // Rango de 1 día: mandamos la misma fecha como start y end.
            const startdate = date;
            const enddate = date;

            return {
                company,
                workplace,
                manufacturingorder: null, // ya no filtramos por SKU
                startdate,
                enddate
            };
        }


        // --- buscar y pintar grid ---
        async function buscarACs() {
            const payload = getPayload();

            const res = await fetch('@Url.Action("ObtenerRows", "CargaACs")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const txt = await res.text().catch(() => '');
                console.error('ObtenerRows error', res.status, txt);
                alert('Error al consultar.');
                return;
            }

            const js = await res.json();
            const raw = (js?.rows ?? js);
            const rows = Array.isArray(raw) ? raw : (raw?.$values ?? []);
            renderGrid(rows);
            $("#gridCount").text(`${js?.count ?? rows.length} fila(s)`);
        }

        function renderGrid(rows) {
            const $wrap = $("#gridWrap");
            const $thead = $("#gridAC thead");
            const $tbody = $("#gridAC tbody");
            $thead.empty(); $tbody.empty();

            if (!Array.isArray(rows) || rows.length === 0) {
                $wrap.show();
                $thead.html('<tr><th>Sin datos</th></tr>');
                return;
            }

            const cols = Object.keys(rows[0] || {});
            const ths = cols.map(k => `<th>${k}</th>`).join('');
            $thead.html(`<tr>${ths}</tr>`);

            const html = rows.map(r => {
                const tds = cols.map(c => {
                    let v = r[c];
                    if (typeof v === 'string' && v.includes('T') && /^\d{4}-\d{2}-\d{2}T/.test(v)) {
                        v = v.split('T')[0] + ' ' + (v.split('T')[1] || '').substring(0, 8);
                    }
                    return `<td>${v ?? ''}</td>`;
                }).join('');
                return `<tr>${tds}</tr>`;
            }).join('');

            $tbody.html(html);
            $wrap.show();
        }


        // --- bindings ---
        $("#pais").on("change", function () { fillPlants(this.value); });
        $("#planta").on("change", function () { loadWorkplacesByCompany(this.value); });
        $("#btnBuscar").on("click", buscarACs);


        // init: seleccionar primer país y disparar llenado
        $(function () {
            const $pais = $("#pais");
            if ($pais[0] && $pais[0].options.length > 1) {
                $pais[0].selectedIndex = 1;
                $pais.trigger("change");
            }
        });


        async function exportExcelACs() {
            const payload = getPayload();

            const res = await fetch('@Url.Action("ExportRows", "CargaACs")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const txt = await res.text().catch(() => '');
                console.error('ExportRows error', res.status, txt);
                alert('No se pudo exportar.');
                return;
            }

            const blob = await res.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Autocontroles_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.xlsx`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(a.href);
        }

        $("#btnExport").on("click", exportExcelACs);



        function importarExcelACs() {
            var fileInput = document.getElementById('fileACs');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Primero selecciona un archivo Excel.');
                return;
            }

            var formData = new FormData();
            formData.append('file', fileInput.files[0]);

            // Mostrar overlay
            $("#loaderOverlay").show();

            $.ajax({
                url: '@Url.Action("ImportarExcel", "CargaACs")',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                dataType: 'json',       // <- fuerza parseo a JSON

                success: function (res) {
                    console.log('respuesta ImportarExcel:', res);

                    var html = '';

                    html += '<p>';
                    html += 'Se leyeron <strong>' + (res.totalFilas ?? 0) + '</strong> filas de Excel.<br>';
                    html += 'Se generaron <strong>' + (res.totalPayloads ?? 0) + '</strong> autocontroles (CPR).<br>';
                    html += 'Enviados OK: <strong>' + (res.enviadosOk ?? 0) + '</strong>, ';
                    html += 'Errores: <strong>' + (res.enviadosError ?? 0) + '</strong>';
                    html += '</p>';

                    // 🔴 ANTES intentábamos tratarlo a mano
                    // 🔵 AHORA: usamos tu helper toArray
                    var filasDet = toArray(res.filasDetalle);
                    console.log('filasDet (array final):', filasDet);

                    if (filasDet.length > 0) {
                        html += '<h5>Registros procesados</h5>';
                        html += '<div style="max-height: 400px; overflow: auto;">';
                        html += '<table class="table table-sm table-bordered">';
                        html += '<thead><tr>';
                        html += '<th>batch</th>';
                        html += '<th>controlOperation</th>';
                        html += '<th>controlOperationNote</th>';
                        html += '<th>controlProcedure</th>';
                        html += '<th>controlProcedureNote</th>';
                        html += '<th>controlProcedureVersion</th>';
                        html += '<th>launchingDate</th>';
                        html += '<th>manufacturingOrder</th>';
                        html += '<th>resultAttribute</th>';
                        html += '<th>resultValue</th>';
                        html += '<th>worker</th>';
                        html += '<th>workplace</th>';
                        html += '<th>Estado</th>';
                        html += '<th>Mensaje</th>';
                        html += '</tr></thead><tbody>';

                        filasDet.forEach(function (f) {
                            var cls = '';
                            if (f.status === 'OK') cls = 'table-success';
                            else if (f.status === 'ERROR') cls = 'table-danger';

                            html += '<tr class="' + cls + '">';
                            html += '<td>' + (f.batch || '') + '</td>';
                            html += '<td>' + (f.controlOperation || '') + '</td>';
                            html += '<td>' + (f.controlOperationNote || '') + '</td>';
                            html += '<td>' + (f.controlProcedure || '') + '</td>';
                            html += '<td>' + (f.controlProcedureNote || '') + '</td>';
                            html += '<td>' + (f.controlProcedureVersion || '') + '</td>';
                            html += '<td>' + (f.launchingDate || '') + '</td>';
                            html += '<td>' + (f.manufacturingOrder || '') + '</td>';
                            html += '<td>' + (f.resultAttribute || '') + '</td>';
                            html += '<td>' + (f.resultValue || '') + '</td>';
                            html += '<td>' + (f.worker || '') + '</td>';
                            html += '<td>' + (f.workplace || '') + '</td>';
                            html += '<td>' + (f.status || '') + '</td>';
                            html += '<td>' + (f.message || '') + '</td>';
                            html += '</tr>';
                        });

                        html += '</tbody></table>';
                        html += '</div>';
                    }

                    $('#importResult').html(html);
                },


                error: function (xhr) {
                    console.error('Error AJAX ImportarExcel:', xhr);
                    alert('Error al importar: ' + (xhr.responseText || xhr.statusText));
                },

                complete: function () {
                    // Ocultar overlay siempre
                    $("#loaderOverlay").hide();
                }
            });
        }




        window.addEventListener("load", function () { const loader = document.getElementById("loaderOverlay"); if (loader) loader.style.display = "none"; });

    </script>

}