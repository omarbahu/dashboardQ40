@model List<dashboardQ40.Models.CapabilityRow>
@inject Microsoft.Extensions.Localization.IStringLocalizer Localizer

@{
    ViewData["Title"] = Localizer["CPKsSummary_Title"]; // "CPK Summary"
}
<style>
    .grp-process {
        background: #f3f6fb;
        font-weight: 700;
    }

    .grp-part {
        background: #fafafa;
        font-weight: 600;
    }

    .tbl-cpk th, .tbl-cpk td {
        padding: 4px 8px;
    }
</style>
<h4>@Localizer["CPKsSummary_Header"]</h4>

<form id="selectionForm">
    <div class="row row-cols-lg-auto g-2 align-items-end">
        <div class="col">
            <label for="startDate" class="form-label">@Localizer["From"]</label>
        </div>
        <div class="col">
            <input type="datetime-local" id="startDate" name="startDate" class="form-control form-control-sm" />
        </div>
        <div class="col">
            <label for="endDate" class="form-label">@Localizer["To"]</label>
        </div>
        <div class="col">
            <input type="datetime-local" id="endDate" name="endDate" class="form-control form-control-sm" />
        </div>
        <!-- País / Planta -->
        <div class="col">
            <label for="pais" class="form-label">@Localizer["XR_Country"]</label>
        </div>
        <div class="col">
            <select id="pais" class="form-select form-select-sm">
                <option value="">-- Selecciona --</option>
                @foreach (var p in ViewBag.Countries)
                {
                    <option value="@p.Code">@p.Name</option>
                }
            </select>
        </div>
        <div class="col">
            <label for="planta" class="form-label">@Localizer["XR_Plant"]</label>
        </div>
        <div class="col">
            <select id="planta" name="planta" class="form-select form-select-sm">
                <option value="">-- Selecciona --</option>
            </select>
        </div>

        <div class="col">
            <button id="btnReporte" type="button" class="btn btn-primary btn-sm" disabled
                    onclick="submitForm('@Url.Action("ResumenCPKs","Dashboard")')">
                📊 @Localizer["Report"]
            </button>
        </div>
        <div id="loading" class="col text-muted small" style="display:none;">@Localizer["LoadingInline"]</div>
    </div>
</form>
@if (!string.IsNullOrEmpty(ViewBag.ErrorMessage as string))
{
    <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
}

<table class="table table-sm table-striped tbl-cpk">

    <thead>
        <tr>
            <th>@Localizer["Table_Part"]</th>
            <th>@Localizer["Table_Process"]</th>
            <th>@Localizer["Table_Test"]</th>
            <th class="text-end">@Localizer["Table_Subgroups"]</th>
            <th class="text-end">@Localizer["Table_Mean"]</th>
            <th class="text-end">@Localizer["Table_DeltaMean"]</th>
            <th class="text-end">@Localizer["Table_Cp"]</th>
            <th class="text-end">@Localizer["Table_Cpk"]</th>
            <th>@Localizer["Table_Note"]</th>
        </tr>
    </thead>
    <tbody>
        @{
            if (Model == null || !Model.Any())
            {
                <tr><td colspan="9" class="text-center text-muted">@Localizer["NoData_SelectDates"]</td></tr>
            }
            else
            {
                // 1) Ordenar por Línea → SKU → Variable con claves normalizadas
                Func<string, string> norm = s => (s ?? "").Trim().ToUpperInvariant();
                var rows = Model
                .OrderBy(r => norm(r.Process))
                .ThenBy(r => norm(r.Part))
                .ThenBy(r => norm(r.Test))
                .ToList();

                string lastProcess = null;
                string lastPart = null;

                // 2) Pintar encabezados de grupo usando la MISMA normalización para comparar
                foreach (var r in rows)
                {
                    var pKey = norm(r.Process);
                    var sKey = norm(r.Part);

                    if (lastProcess != pKey)
                    {
                        lastProcess = pKey;
                        lastPart = null;
                        <tr class="grp-process">
                            <td colspan="9">📍 @Localizer["Group_Line", r.Process]</td>
                        </tr>
                    }

                    if (lastPart != sKey)
                    {
                        lastPart = sKey;
                        <tr class="grp-part">
                            <td colspan="9">🔹 @Localizer["Group_SKU", r.Part]</td>
                        </tr>
                    }

                    <tr>
                        <td>@r.Part</td>
                        <td>@r.Process</td>
                        <td>@r.Test</td>
                        <td class="text-end">@r.Subgroups</td>
                        <td class="text-end">@r.Mean.ToString("0.###")</td>
                        <td class="text-end">@((r.MeanDelta)?.ToString("0.###"))</td>
                        <td class="text-end">@((r.Cp)?.ToString("0.##"))</td>
                        <td class="text-end">@((r.Cpk)?.ToString("0.##"))</td>
                        <td>@r.Nota</td>
                    </tr>
                }
            }
        }

    </tbody>

</table>

@section Scripts {
    <script>
        (() => {
            const TXT = {
                StartBeforeEnd: '@Localizer["Validate_StartBeforeEnd"]',   // "Start date must be earlier than end date."
                SelectStartEnd: '@Localizer["Validate_SelectStartEnd"]'    // "Select start and end dates."
            };

            const form = document.getElementById('selectionForm');
            const startI = document.getElementById('startDate');
            const endI = document.getElementById('endDate');
            const btn = document.getElementById('btnReporte');
            const loading = document.getElementById('loading');

            const pad = n => String(n).padStart(2, '0');
            const toLocalInput = d =>
                `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;

            // defaults: last 7 days
            const now = new Date();
            const start = new Date(now);
            start.setDate(now.getDate() - 7);
            start.setHours(0, 0, 0, 0);
            startI.value = toLocalInput(start);
            endI.value = toLocalInput(now);

            function validate() {
                const sv = startI.value, ev = endI.value;
                let ok = false, msg = '';
                if (sv && ev) {
                    const sd = new Date(sv), ed = new Date(ev);
                    ok = sd < ed;
                    if (!ok) msg = TXT.StartBeforeEnd;
                }
                btn.disabled = !ok;
                btn.title = ok ? '' : (sv && ev ? msg : TXT.SelectStartEnd);
                return ok;
            }
            startI.addEventListener('input', validate);
            endI.addEventListener('input', validate);
            validate();

            // submit on same page (GET)
            window.submitForm = function (actionUrl) {
                if (!validate()) return;

                loading.style.display = 'inline';
                btn.disabled = true;

                form.action = actionUrl;
                form.method = 'get';

                // tzOffset
                let tz = document.getElementById('tzOffset');
                if (!tz) {
                    tz = document.createElement('input');
                    tz.type = 'hidden';
                    tz.name = 'tzOffset';
                    tz.id = 'tzOffset';
                    form.appendChild(tz);
                }
                tz.value = new Date().getTimezoneOffset();

                form.submit();
            };
        })();


        // Etiquetas (puedes cambiarlas o usar Localizer)
        const MODULO_PERMISOS = "DQcpk";

        const LABELS = {
            Select: "-- Selecciona --",
            Line: "@Localizer["XR_Line"]",
            Plant: "@Localizer["XR_Plant"]"
        };

        // Todas las companies (Company, CompanyName, CountryCode) desde backend
        const COMPANIES = @Html.Raw(ViewBag.CompaniesJson ?? "[]");
        console.log("companies", COMPANIES);

        function toArray(data) {
            if (!data) return [];
            if (Array.isArray(data)) return data;
            if (Array.isArray(data.$values)) return data.$values;
            if (Array.isArray(data.value?.$values)) return data.value.$values;
            if (Array.isArray(data.value)) return data.value;
            return [];
        }

        function resetSelect($el, placeholder) {
            $el.empty().append(new Option(placeholder, ""));
        }

        // Helpers de permisos
        function getPermisoModulo() {
            if (!window.PERMISOS_POR_MODULO) return null;
            return window.PERMISOS_POR_MODULO[MODULO_PERMISOS] || null;
        }

        function getUserCompanyInfo() {
            if (!window.USER_COMPANY || !Array.isArray(COMPANIES)) return null;
            return COMPANIES.find(c => c.Company === window.USER_COMPANY) || null;
        }

        // 1) País → cargar Plantas
        // País → cargar Plantas
        function fillPlants(countryCode) {
            const $planta = $("#planta");
            resetSelect($planta, LABELS.Plant);
            resetSelect($("#line"), LABELS.Line); // limpiar línea

            if (!countryCode) return;

            const permiso = getPermisoModulo();
            const userInfo = getUserCompanyInfo();
            const userCompany = userInfo ? userInfo.Company : null;

            let plants = COMPANIES
                .filter(c => c.CountryCode === countryCode)
                .sort((a, b) => a.CompanyName.localeCompare(b.CompanyName, 'es'));

            // SOLO si fuera nivel planta puro (Global=false, Country=false, Planta=true)
            // limitaríamos a una planta. En DQanasens tienes Country=true, así que ve todas las plantas de México.
            if (permiso && !permiso.Global && !permiso.Country && permiso.Planta && userCompany) {
                plants = plants.filter(p => p.Company === userCompany);
            }

            plants.forEach(p => $planta.append(new Option(p.CompanyName, p.Company)));

            // Si tiene permiso de planta, auto-seleccionar su planta
            // Si el permiso es SOLO de planta (sin Global ni Country) → auto-seleccionar y bloquear
            if (permiso && permiso.Planta && userCompany && !permiso.Global && !permiso.Country) {
                $planta.val(userCompany);
                $planta.prop("disabled", true);
            } else {
                // En cualquier otro caso: no forzar selección, dejarlo editable
                $planta.prop("disabled", false);
            }

        }


        // Eventos
        $("#pais").on("change", function () {
            fillPlants(this.value);
        });

        $(function () {
            const $pais = $("#pais");
            const permiso = getPermisoModulo();
            const userInfo = getUserCompanyInfo();
            const userCountry = userInfo ? userInfo.CountryCode : null;

            if (!$pais[0]) return;

            // Si tiene Global → puede ver todos los países
            if (permiso && permiso.Global) {
                if (userCountry) {
                    $pais.val(userCountry);
                } else if ($pais[0].options.length > 1) {
                    $pais[0].selectedIndex = 1;
                }
                $pais.prop("disabled", false);
            }
            // Si NO Global pero sí Country/Planta → solo su país, bloqueado
            else if (permiso && (permiso.Country || permiso.Planta) && userCountry) {
                $pais.find("option").each(function () {
                    const val = this.value;
                    if (val && val !== userCountry) {
                        $(this).remove();
                    }
                });
                $pais.val(userCountry);
                $pais.prop("disabled", true);
            }
            // Fallback (sin permisos, por si acaso)
            else {
                if ($pais[0].options.length > 1) {
                    $pais[0].selectedIndex = 1;
                }
                $pais.prop("disabled", false);
            }

            // Disparar carga de plantas con el país seleccionado
            const selectedCountry = $pais.val();
            if (selectedCountry) {
                fillPlants(selectedCountry);
            }
        });

    </script>
}
