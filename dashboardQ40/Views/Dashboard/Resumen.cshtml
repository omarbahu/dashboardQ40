@model List<dashboardQ40.Models.CapabilityRow>
@inject Microsoft.Extensions.Localization.IStringLocalizer Localizer

@{
    ViewData["Title"] = Localizer["CPKsSummary_Title"]; // "CPK Summary"
}

<h4>@Localizer["CPKsSummary_Header"]</h4>

<form id="selectionForm">
    <div class="row row-cols-lg-auto g-2 align-items-end">
        <div class="col">
            <label for="startDate" class="form-label">@Localizer["From"]</label>
        </div>
        <div class="col">
            <input type="datetime-local" id="startDate" name="startDate" class="form-control form-control-sm" />
        </div>
        <div class="col">
            <label for="endDate" class="form-label">@Localizer["To"]</label>
        </div>
        <div class="col">
            <input type="datetime-local" id="endDate" name="endDate" class="form-control form-control-sm" />
        </div>
        <div class="col">
            <button id="btnReporte" type="button" class="btn btn-primary btn-sm" disabled
                    onclick="submitForm('@Url.Action("ResumenCPKs","Dashboard")')">
                📊 @Localizer["Report"]
            </button>
        </div>
        <div id="loading" class="col text-muted small" style="display:none;">@Localizer["LoadingInline"]</div>
    </div>
</form>
@if (!string.IsNullOrEmpty(ViewBag.ErrorMessage as string))
{
    <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
}

<table class="table table-sm table-striped">
    <thead>
        <tr>
            <th>@Localizer["Table_Part"]</th>
            <th>@Localizer["Table_Process"]</th>
            <th>@Localizer["Table_Test"]</th>
            <th class="text-end">@Localizer["Table_Subgroups"]</th>
            <th class="text-end">@Localizer["Table_Mean"]</th>
            <th class="text-end">@Localizer["Table_DeltaMean"]</th>
            <th class="text-end">@Localizer["Table_Cp"]</th>
            <th class="text-end">@Localizer["Table_Cpk"]</th>
            <th>@Localizer["Table_Note"]</th>
        </tr>
    </thead>
    <tbody>
        @if (Model == null || !Model.Any())
        {
            <tr><td colspan="9" class="text-center text-muted">@Localizer["NoData_SelectDates"]</td></tr>
        }
        else
        {
            foreach (var r in Model)
            {
                <tr>
                    <td>@r.Part</td>
                    <td>@r.Process</td>
                    <td>@r.Test</td>
                    <td class="text-end">@r.Subgroups</td>
                    <td class="text-end">@r.Mean.ToString("0.###")</td>
                    <td class="text-end">@((r.MeanDelta)?.ToString("0.###"))</td>
                    <td class="text-end">@((r.Cp)?.ToString("0.##"))</td>
                    <td class="text-end">@((r.Cpk)?.ToString("0.##"))</td>
                    <td>@r.Nota</td>
                </tr>
            }
        }
    </tbody>
</table>

@section Scripts {
    <script>
        (() => {
            const TXT = {
                StartBeforeEnd: '@Localizer["Validate_StartBeforeEnd"]',   // "Start date must be earlier than end date."
                SelectStartEnd: '@Localizer["Validate_SelectStartEnd"]'    // "Select start and end dates."
            };

            const form = document.getElementById('selectionForm');
            const startI = document.getElementById('startDate');
            const endI = document.getElementById('endDate');
            const btn = document.getElementById('btnReporte');
            const loading = document.getElementById('loading');

            const pad = n => String(n).padStart(2, '0');
            const toLocalInput = d =>
                `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;

            // defaults: last 7 days
            const now = new Date();
            const start = new Date(now);
            start.setDate(now.getDate() - 7);
            start.setHours(0, 0, 0, 0);
            startI.value = toLocalInput(start);
            endI.value = toLocalInput(now);

            function validate() {
                const sv = startI.value, ev = endI.value;
                let ok = false, msg = '';
                if (sv && ev) {
                    const sd = new Date(sv), ed = new Date(ev);
                    ok = sd < ed;
                    if (!ok) msg = TXT.StartBeforeEnd;
                }
                btn.disabled = !ok;
                btn.title = ok ? '' : (sv && ev ? msg : TXT.SelectStartEnd);
                return ok;
            }
            startI.addEventListener('input', validate);
            endI.addEventListener('input', validate);
            validate();

            // submit on same page (GET)
            window.submitForm = function (actionUrl) {
                if (!validate()) return;

                loading.style.display = 'inline';
                btn.disabled = true;

                form.action = actionUrl;
                form.method = 'get';

                // tzOffset
                let tz = document.getElementById('tzOffset');
                if (!tz) {
                    tz = document.createElement('input');
                    tz.type = 'hidden';
                    tz.name = 'tzOffset';
                    tz.id = 'tzOffset';
                    form.appendChild(tz);
                }
                tz.value = new Date().getTimezoneOffset();

                form.submit();
            };
        })();
    </script>
}
