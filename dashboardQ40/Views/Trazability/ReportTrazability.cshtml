@using System.Data
@model dashboardQ40.Models.TrazabilidadConChecklistViewModel
@inject Microsoft.Extensions.Localization.IStringLocalizer Localizer

@{
    ViewBag.Title = Localizer["Trace_BackwardReport_Title"];

    // JSON de tabla para depurar
    string traceJson = "{}";
    if (Model?.Trazabilidad != null && Model.Trazabilidad.Rows.Count > 0)
    {
        var t = Model.Trazabilidad;
        var cols = t.Columns.Cast<DataColumn>().Select(c => c.ColumnName).ToList();
        var rows = t.Rows.Cast<DataRow>().Select(r => cols.ToDictionary(c => c, c => r[c]?.ToString() ?? "")).ToList();
        traceJson = System.Text.Json.JsonSerializer.Serialize(new { columnas = cols, filas = rows });
    }

    // JSON de filas para construir el grafo (si no hay datos, que sea [] y listo)
    string rowsJson = "[]";
    if (Model?.Trazabilidad != null && Model.Trazabilidad.Rows.Count > 0)
    {
        rowsJson = System.Text.Json.JsonSerializer.Serialize(
            Model.Trazabilidad.Rows.Cast<DataRow>().Select(r => new
            {
                padre = r["batchIdentifier"]?.ToString(),
                hijo = r["batchname"]?.ToString(),
                nombre = r["manufacturingReferenceName"]?.ToString(),
                id = r["manufacturingReference"]?.ToString(),
                inicio = r["startDate"]?.ToString(),
                fin = r["endDate"]?.ToString()
            })
        );
    }
}


<div class="container mt-5">
    <h2>@Localizer["Trace_BackwardReport_Header"]</h2>

    <form method="get" action="@Url.Action("ReportTrazability", "Trazability")" class="d-flex align-items-center gap-2 mb-2">
        <!-- País / Planta -->
        <div class="col">
            <label for="pais" class="form-label">@Localizer["XR_Country"]</label>
        </div>
        <div class="col">
            <select id="pais" class="form-select form-select-sm">
                <option value="">-- Selecciona --</option>
                @foreach (var p in ViewBag.Countries)
                {
                    <option value="@p.Code">@p.Name</option>
                }
            </select>
        </div>
        <div class="col">
            <label for="planta" class="form-label">@Localizer["XR_Plant"]</label>
        </div>
        <div class="col">
            <select id="planta" name="planta" class="form-select form-select-sm">
                <option value="">-- Selecciona --</option>
            </select>
        </div>
        <input id="txtSearchBatch" type="text" name="searchBatch" class="form-control form-control-sm w-auto"
               placeholder="@Localizer["Trace_SearchBatch_Placeholder"]" value="@Model?.SearchBatch" style="max-width: 200px;" />
        <button id="btnBuscar" type="submit" class="btn btn-sm btn-primary">@Localizer["Search"]</button>

        <button type="button" id="btnBuscarPorFechas" class="btn btn-sm btn-outline-secondary">
            @Localizer["Trace_SearchByDates"]
        </button>
    </form>

    <!-- Modal: Buscar lotes por fechas -->
    <div class="modal fade" id="modalBuscarLotes" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@Localizer["Trace_Modal_Title"]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@Localizer["Close"]"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2 mb-3">
                        <div class="col-12 col-md-4">
                            <label class="form-label mb-1">@Localizer["Date_Start"]</label>
                            <input id="fechaIni" type="date" class="form-control form-control-sm" />
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label mb-1">@Localizer["Date_End"]</label>
                            <input id="fechaFin" type="date" class="form-control form-control-sm" />
                        </div>
                        <div class="col-12 col-md-4 d-flex align-items-end">
                            <button id="btnConsultarLotes" class="btn btn-sm btn-primary w-100">@Localizer["Consult"]</button>
                        </div>
                    </div>

                    <div class="table-responsive border rounded">
                        <table class="table table-sm table-hover align-middle mb-0" id="tablaLotes">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:160px;">@Localizer["Lot"]</th>
                                    <th>@Localizer["Description_SKU"]</th>
                                    <th style="width:180px;">@Localizer["Start"]</th>
                                    <th style="width:180px;">@Localizer["End"]</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="msgLotes" class="small text-muted mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">@Localizer["Close"]</button>
                </div>
            </div>
        </div>
    </div>


    @if (Model?.Trazabilidad != null && Model.Trazabilidad.Rows.Count > 0)
    {
        <div id="visorTrazabilidad" style="height: 400px; width: 100%; margin-bottom: 30px;"></div>

        
    }

    <button class="btn btn-primary" onclick="window.print()">@Localizer["PrintReport"]</button>
</div>


<br />
<br />
@if (Model?.StartDate.HasValue == true && Model.EndDate.HasValue == true)
{
    <div class="d-flex align-items-center gap-3 flex-wrap mb-3">
        <div style="flex: 1; min-width: 280px; padding-bottom: 10px;">
            <div id="rangeSlider"></div>
        </div>

        <div class="small d-flex gap-2 flex-wrap align-items-center">
            <span><strong>@Localizer["From"]</strong> <span id="displayStart"></span></span>
            <span><strong>@Localizer["To"]</strong> <span id="displayEnd"></span></span>

            <form method="get" action="@Url.Action("ReportTrazability", "Trazability")" class="d-flex align-items-center gap-2">
                <input type="hidden" name="searchBatch" value="@Model.SearchBatch" />
                <input type="hidden" id="startDateInput" name="startDate" />
                <input type="hidden" id="endDateInput" name="endDate" />
                <button type="submit" class="btn btn-sm btn-outline-secondary">🔍 @Localizer["Filter"]</button>
            </form>
        </div>
    </div>
}
</BR></BR>

@if (Model.Checklist != null && Model.Checklist.Rows.Count > 0)
{
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>@Localizer["Lot"]</th>
                <th>@Localizer["BatchIdentifier"]</th>
                <th>@Localizer["Start"]</th>
                <th>@Localizer["End"]</th>
                <th>@Localizer["SKU"]</th>
                <th>@Localizer["Line"]</th>
                <th>@Localizer["Variable"]</th>
                <th>@Localizer["Result"]</th>
                <th>@Localizer["Min"]</th>
                <th>@Localizer["Max"]</th>
                <th>@Localizer["Count"]</th>
                <th>@Localizer["Defects"]</th>
                <th>@Localizer["Mean"]</th>
                <th>@Localizer["Sigma"]</th>
                <th>@Localizer["Cp"]</th>
                <th>@Localizer["Cpk"]</th>
            </tr>
        </thead>
        <tbody>
            @{
                string previousBatch = string.Empty;
                string previousManufacturingReference = string.Empty;
            }
            @{
                var lotesUnicos = Model.Trazabilidad
                .AsEnumerable()
                .GroupBy(r => r["batch"].ToString())
                .Select(g => g.First())
                .ToList();
            }


            @foreach (var batchRow in lotesUnicos)
            {
                string batch = batchRow["batch"].ToString();
                string batchIdentifier = batchRow["batchname"].ToString();
                string creacionLote = batchRow["startDate"].ToString();
                string finLote = batchRow["endDate"].ToString();
                string manufacturingReference = batchRow["manufacturingReferencename"].ToString();

                // Obtener checklist asociados a este batch
                var checklistFiltrados = new List<DataRow>();
                foreach (DataRow c in Model.Checklist.Rows)
                {
                    bool coincideBatch = !string.IsNullOrEmpty(c["batch"].ToString()) && c["batch"].ToString() == batch;
                    bool coincideReferencia = c["manufacturingReference"].ToString() == batchRow["manufacturingReference"].ToString();
                    if (coincideBatch || coincideReferencia)
                    {
                        checklistFiltrados.Add(c);
                    }
                }

                if (checklistFiltrados.Count == 0)
                {
                    <tr>
                        <td>@batch</td>
                        <td>@batchIdentifier</td>
                        <td>@creacionLote</td>
                        <td>@finLote</td>
                        <td>@manufacturingReference</td>
                        <td colspan="12">@Localizer["NoChecklistRecords"]</td>
                    </tr>
                }
                else
                {
                    // 🔹 Agrupamos por VARIABLE para no repetir filas
                    var gruposVariables = checklistFiltrados
                    .GroupBy(r => r["controlOperationName"].ToString())
                    .OrderBy(g => g.Key)
                    .ToList();

                    bool mostrarInfoLote = true;

                    foreach (var grupo in gruposVariables)
                    {
                        // Fila de referencia para datos fijos (línea, tolerancias, etc.)
                        var rowRef = grupo.First();
                        string variable = rowRef["controlOperationName"].ToString();
                        string key = $"{batch}|{variable}";
                        var stats = Model.Estadisticas.ContainsKey(key) ? Model.Estadisticas[key] : null;

                        // Buscar una fila con valor numérico (si existe) para la columna "Resultado"
                        DataRow rowNumerica = null;
                        foreach (DataRow r in grupo)
                        {
                            if (r["resultValue"] != DBNull.Value)
                            {
                                rowNumerica = r;
                                break;
                            }
                        }
                        var rowParaOkNok = rowNumerica ?? rowRef;

                        <tr>
                            @* Datos del lote, solo en la primera variable *@
                            @if (mostrarInfoLote)
                            {
                                <td>@batch</td>
                                <td>@batchIdentifier</td>
                                <td>@creacionLote</td>
                                <td>@finLote</td>
                                <td>@manufacturingReference</td>
                                mostrarInfoLote = false;
                            }
                            else
                            {
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            }

                            <td>@(string.IsNullOrEmpty(rowRef["workplace"].ToString()) ? "" : rowRef["workplace"])</td>
                            <td>@variable</td>

                            <td>
                                @* Resultado: si hay valor numérico lo mostramos, si no, el icono OK/NOK *@
                                @if (rowNumerica != null)
                                {
                                    @rowNumerica["resultValue"]
                                }
                                else
                                {
                                    if (rowParaOkNok["resultAttribute"].ToString() == "1")
                                    {
                                        <i class="fa fa-check-circle text-success" title="OK"></i>
                                    }
                                    else
                                    {
                                        <i class="fa fa-times-circle text-danger" title="NOK"></i>
                                    }
                                }
                            </td>

                            <td>@rowRef["minTolerance"]</td>
                            <td>@rowRef["maxTolerance"]</td>

                            <td>@(stats != null ? stats.Conteo : 0)</td>
                            <td>@(stats != null ? stats.Defectos : 0)</td>
                            <td>@(stats != null ? stats.Media.ToString("0.00") : "-")</td>
                            <td>@(stats != null ? stats.Sigma.ToString("0.00") : "-")</td>
                            <td>@(stats != null ? stats.Cp.ToString("0.00") : "-")</td>
                            <td>@(stats != null ? stats.Cpk.ToString("0.00") : "-")</td>
                        </tr>
                    }
                }

            }
        </tbody>
    </table>
}
else if (Model.Checklist != null)
{
    <div class="alert alert-warning">@Localizer["NoChecklistForSelection"]</div>
}


@section Scripts {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
        // Etiquetas (puedes cambiarlas o usar Localizer)
        const MODULO_PERMISOS = "DQtrazlineal";

        const LABELS = {
            Select: "-- Selecciona --",
            Line: "@Localizer["XR_Line"]",
            Plant: "@Localizer["XR_Plant"]"
        };

        // Todas las companies (Company, CompanyName, CountryCode) desde backend
        const COMPANIES = @Html.Raw(ViewBag.CompaniesJson ?? "[]");
        console.log("companies", COMPANIES);

        function toArray(data) {
            if (!data) return [];
            if (Array.isArray(data)) return data;
            if (Array.isArray(data.$values)) return data.$values;
            if (Array.isArray(data.value?.$values)) return data.value.$values;
            if (Array.isArray(data.value)) return data.value;
            return [];
        }

        function resetSelect($el, placeholder) {
            $el.empty().append(new Option(placeholder, ""));
        }

        // Helpers de permisos
        function getPermisoModulo() {
            if (!window.PERMISOS_POR_MODULO) return null;
            return window.PERMISOS_POR_MODULO[MODULO_PERMISOS] || null;
        }

        function getUserCompanyInfo() {
            if (!window.USER_COMPANY || !Array.isArray(COMPANIES)) return null;
            return COMPANIES.find(c => c.Company === window.USER_COMPANY) || null;
        }

        // 1) País → cargar Plantas
        // País → cargar Plantas
        function fillPlants(countryCode) {
            const $planta = $("#planta");
            resetSelect($planta, LABELS.Plant);
            resetSelect($("#line"), LABELS.Line); // limpiar línea

            if (!countryCode) return;

            const permiso = getPermisoModulo();
            const userInfo = getUserCompanyInfo();
            const userCompany = userInfo ? userInfo.Company : null;

            let plants = COMPANIES
                .filter(c => c.CountryCode === countryCode)
                .sort((a, b) => a.CompanyName.localeCompare(b.CompanyName, 'es'));

            // SOLO si fuera nivel planta puro (Global=false, Country=false, Planta=true)
            // limitaríamos a una planta. En DQanasens tienes Country=true, así que ve todas las plantas de México.
            if (permiso && !permiso.Global && !permiso.Country && permiso.Planta && userCompany) {
                plants = plants.filter(p => p.Company === userCompany);
            }

            plants.forEach(p => $planta.append(new Option(p.CompanyName, p.Company)));

            // Si tiene permiso de planta, auto-seleccionar su planta
            // Si el permiso es SOLO de planta (sin Global ni Country) → auto-seleccionar y bloquear
            if (permiso && permiso.Planta && userCompany && !permiso.Global && !permiso.Country) {
                $planta.val(userCompany);
                $planta.prop("disabled", true);
            } else {
                // En cualquier otro caso: no forzar selección, dejarlo editable
                $planta.prop("disabled", false);
            }

        }


        // Eventos
        $("#pais").on("change", function () {
            fillPlants(this.value);
        });

        $(function () {
            const $pais = $("#pais");
            const permiso = getPermisoModulo();
            const userInfo = getUserCompanyInfo();
            const userCountry = userInfo ? userInfo.CountryCode : null;

            if (!$pais[0]) return;

            // Si tiene Global → puede ver todos los países
            if (permiso && permiso.Global) {
                if (userCountry) {
                    $pais.val(userCountry);
                } else if ($pais[0].options.length > 1) {
                    $pais[0].selectedIndex = 1;
                }
                $pais.prop("disabled", false);
            }
            // Si NO Global pero sí Country/Planta → solo su país, bloqueado
            else if (permiso && (permiso.Country || permiso.Planta) && userCountry) {
                $pais.find("option").each(function () {
                    const val = this.value;
                    if (val && val !== userCountry) {
                        $(this).remove();
                    }
                });
                $pais.val(userCountry);
                $pais.prop("disabled", true);
            }
            // Fallback (sin permisos, por si acaso)
            else {
                if ($pais[0].options.length > 1) {
                    $pais[0].selectedIndex = 1;
                }
                $pais.prop("disabled", false);
            }

            // Disparar carga de plantas con el país seleccionado
            const selectedCountry = $pais.val();
            if (selectedCountry) {
                fillPlants(selectedCountry);
            }
        });
    </script>


    <script>
  // ===== Textos para JS =====
  window.TRZ = {
    NoInfo: '@Localizer["NoInfo"]',
    ManufacturedLot: '@Localizer["ManufacturedLot"]',
    SKU: '@Localizer["SKU"]',
    Identifier: '@Localizer["Identifier"]',
    Start: '@Localizer["Start"]',
    End: '@Localizer["End"]',
    ViewDetail: '@Localizer["ViewDetail"]'
  };

  const host = document.getElementById('visorTrazabilidad');
  if (host && window.echarts) {
    const chart = echarts.init(host);

    // 👇 variables correctas
    const trazabilidadDebug = @Html.Raw(traceJson);
    const rows = @Html.Raw(rowsJson);   // <- array JS, no usa .$values

    const data = [];
    const links = [];
    const added = new Map();

    (rows || []).forEach(r => {
      if (!added.has(r.padre)) {
        added.set(r.padre, true);
        data.push({
          id: r.padre, name: r.padre, symbolSize: [140, 40],
          info: { sku: r.nombre, id: r.padre, inicio: r.inicio, fin: r.fin }
        });
      }
      if (r.hijo && !added.has(r.hijo)) {
        added.set(r.hijo, true);
        data.push({
          id: r.hijo, name: r.hijo, symbolSize: [140, 40],
          info: { sku: r.nombre, id: r.hijo, inicio: r.inicio, fin: r.fin }
        });
      }
      if (r.padre && r.hijo) links.push({ source: r.padre, target: r.hijo });
    });

    const hijos = new Set(rows.map(r => r.hijo));
    const padres = [...new Set(rows.map(r => r.padre))];
    let rootId = padres.find(p => !hijos.has(p)) || padres[0];

    const uniqueLinks = [];
    const seenLinks = new Set();
    links.forEach(link => {
      const key = `${link.source}→${link.target}`;
      if (!seenLinks.has(key)) { seenLinks.add(key); uniqueLinks.push(link); }
    });

    function buildTreeSafe(rootId, visited = new Set()) {
      if (visited.has(rootId)) return null;
      visited.add(rootId);
      const rootNode = data.find(n => n.id === rootId);
      if (!rootNode) return null;
      const children = uniqueLinks
        .filter(link => link.source === rootId)
        .map(link => buildTreeSafe(link.target, new Set(visited)))
        .filter(child => child !== null);
      return { ...rootNode, children };
    }

    chart.setOption({
      tooltip: {
        trigger: 'item', enterable: true, confine: true,
        backgroundColor: '#fff', borderColor: '#ccc', borderWidth: 1,
        textStyle: { color: '#000' },
        formatter: function (p) {
          const i = p.data.info; if (!i) return TRZ.NoInfo;
          return `<div style="max-width:240px;font-size:12px;">
            <b>${TRZ.ManufacturedLot}</b><br/>
            <b>${TRZ.SKU}:</b> ${i.sku}<br/>
            <b>${TRZ.Identifier}:</b> ${i.id}<br/>
            <b>${TRZ.Start}:</b> ${i.inicio}<br/>
            <b>${TRZ.End}:</b> ${i.fin}<br/>
            <a href="javascript:void(0)" onclick="filtrarLote('${i.id}')">🔍 ${TRZ.ViewDetail}</a>
          </div>`;
        }
      },
      series: [{
        type: 'tree', layout: 'orthogonal', orient: 'LR',
        data: [buildTreeSafe(rootId)],
        symbol: 'rect', symbolSize: [160, 70],
        edgeShape: 'polyline', edgeForkPosition: '50%',
        top: '10%', left: '5%', bottom: '10%', right: '20%',
        nodePadding: 30,
        label: {
          show: true, position: 'inside', verticalAlign: 'middle', align: 'center', fontSize: 11,
          formatter: function (p) {
            const i = p.data.info; if (!i) return p.data.name || '';
            const skuShort = (i.sku || '').substring(0, 20);
            return `{b|${p.data.name}}\n{s|${skuShort}}`;
          },
          rich: { b: { fontWeight: 'bold', fontSize: 12 }, s: { fontSize: 10 } }
        },
        leaves: { label: { show: true, position: 'inside', verticalAlign: 'middle', align: 'center', fontSize: 11 } },
        itemStyle: { borderColor: '#666', borderWidth: 1, color: '#eef9ff' },
        expandAndCollapse: true, initialTreeDepth: -1, lineStyle: { color: '#aaa', width: 2 }
      }]
    });

    window.filtrarLote = function (id) {
      const form = document.createElement('form');
      form.method = 'get';
      form.action = '@Url.Action("ReportTrazability", "Trazability")';
      const input = document.createElement('input');
      input.type = 'hidden'; input.name = 'searchBatch'; input.value = id;
      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    };
  }
</script>


    <!-- Script del modal SIEMPRE cargado -->
    <script>
        (function () {
            if (!window.bootstrap) return;

            var modalEl = document.getElementById('modalBuscarLotes');
            if (!modalEl) return;
            var modalBuscarLotes = new bootstrap.Modal(modalEl);

            document.getElementById('btnBuscarPorFechas')?.addEventListener('click', function (e) {
                e.preventDefault();

                // 🔹 Validar planta ANTES de abrir el modal
                const ddlPlanta = document.getElementById('planta');
                const plantaVal = ddlPlanta ? ddlPlanta.value : '';

                if (!plantaVal || plantaVal === "0") {
                    // Puedes usar alert o un mensaje en pantalla
                    alert('@Localizer["Trace_SelectPlant"]'); // ya tienes esta key en el .resx
                    return; // ❌ NO abrimos el modal
                }

                // ✅ Planta OK → ahora sí prellenamos fechas y abrimos modal
                const hoy = new Date().toISOString().slice(0, 10);
                document.getElementById('fechaIni').value = hoy;
                document.getElementById('fechaFin').value = hoy;
                document.querySelector('#tablaLotes tbody').innerHTML = '';
                document.getElementById('msgLotes').textContent = '';
                modalBuscarLotes.show();
            });


            var btnConsultar = document.getElementById('btnConsultarLotes');
            if (btnConsultar) {
                btnConsultar.addEventListener('click', async function (ev) {
                    ev.preventDefault();

                    const ini = document.getElementById('fechaIni').value;
                    const fin = document.getElementById('fechaFin').value;
                    const planta = document.getElementById('planta').value;
                    const msg = document.getElementById('msgLotes');
                    const tbody = document.querySelector('#tablaLotes tbody');
                    tbody.innerHTML = '';

                    if (!ini || !fin) { msg.textContent = '@Localizer["SelectBothDates"]'; return; }
                    if (ini > fin) { msg.textContent = '@Localizer["StartNotAfterEnd"]'; return; }

                    // 👉 NUEVO: validar planta
                if (!planta) {
                    msg.textContent = '@Localizer["Trace_SelectPlant"]'; // crea esta clave en tu .resx
                    return;
                }

                    msg.textContent = '@Localizer["SearchingBatches"]';

                    try {
                        // 🔹 Mostrar loader global (el del _Layout)
                        if (window.showGlobalLoader) window.showGlobalLoader();

                        const url = `@Url.Action("BuscarLotesPorFechas", "Trazability")?fechaIni=${encodeURIComponent(ini)}&fechaFin=${encodeURIComponent(fin)}&planta=${encodeURIComponent(planta)}`;
                        const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
                        if (!resp.ok) throw new Error('net');

                        const data = await resp.json();

                        const items = Array.isArray(data) ? data : (data && Array.isArray(data.$values) ? data.$values : []);

                        if (!items.length) { msg.textContent = '@Localizer["NoResults"]'; return; }

                        tbody.innerHTML = '';
                        items.forEach(x => {
                            const lote = x.lote ?? x.batchIdentifier ?? x.batch ?? '';
                            const desc = x.descripcion ?? x.manufacturingReferenceName ?? '';
                            const inicio = x.inicio ?? x.startDate ?? '';
                            const finv = x.fin ?? x.endDate ?? '';

                            const tr = document.createElement('tr');
                            tr.style.cursor = 'pointer';
                            tr.innerHTML = `
                    <td><code>${lote}</code></td>
                    <td>${desc}</td>
                    <td>${fmtSmart(inicio)}</td>
                    <td>${fmtSmart(finv)}</td>
                `;
                            tr.addEventListener('click', function () {
                                document.getElementById('txtSearchBatch').value = lote || '';
                                modalBuscarLotes.hide();

                                // 🔹 Mostrar loader global ANTES de enviar el form
                                if (window.showGlobalLoader) {
                                    window.showGlobalLoader();
                                }

                                document.getElementById('btnBuscar').closest('form').submit();
                            });

                            tbody.appendChild(tr);
                        });

                        msg.textContent = items.length + ' @Localizer["LotsFound_ClickToSelect"]';
                    } catch (e) {
                        console.error(e);
                        msg.textContent = '@Localizer["ErrorFetchingBatches"]';
                    } finally {
                        // 🔹 Asegurar que se oculte el loader aunque haya error
                        if (window.hideGlobalLoader) window.hideGlobalLoader();
                    }

                });
            }

            function fmtSmart(v) {
                if (!v) return '';
                if (typeof v === 'string' && v.includes('T')) {
                    const d = new Date(v);
                    if (!isNaN(d)) {
                        // Puedes cambiar 'es-MX' si quieres hacerlo dependiente de CultureInfo.CurrentUICulture.Name
                        return d.toLocaleString('es-MX', { dateStyle: 'short', timeStyle: 'short' });
                    }
                }
                return v.toString();
            }
        })();

        (function () {
            const btnBuscar = document.getElementById('btnBuscar');
            const ddlPlanta = document.getElementById('planta');

            if (btnBuscar && ddlPlanta) {
                btnBuscar.addEventListener('click', function (e) {
                    const plantaVal = ddlPlanta.value;

                    // 🔹 Validar planta
                    if (!plantaVal || plantaVal === "0") {
                        e.preventDefault(); // NO enviamos el form
                        alert('@Localizer["Trace_SelectPlant"]');
                        return;
                    }

                    // 🔹 Si todo bien, mostrar loader global antes del submit
                    if (window.showGlobalLoader) {
                        window.showGlobalLoader();
                    }
                    // No hacemos preventDefault: dejamos que el form se envíe normal
                });
            }
        })();
    </script>
}