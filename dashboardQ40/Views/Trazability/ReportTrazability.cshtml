@using System.Data
@model dashboardQ40.Models.TrazabilidadConChecklistViewModel

@{
    ViewBag.Title = "Reporte de Trazabilidad Hacia Atrás";

    string jsonData = "{}"; // Valor por defecto

    if (Model?.Trazabilidad != null && Model.Trazabilidad.Rows.Count > 0)
    {
        var tabla = Model.Trazabilidad;
        var columnas = tabla.Columns.Cast<DataColumn>().Select(c => c.ColumnName).ToList();

        var filas = tabla.Rows.Cast<DataRow>().Select(r =>
            columnas.ToDictionary(c => c, c => r[c]?.ToString() ?? "")
        ).ToList();

        var dataCompleta = new
        {
            columnas,
            filas
        };

        jsonData = System.Text.Json.JsonSerializer.Serialize(dataCompleta);
    }
}

<div class="container mt-5">
    <h2>Reporte de Trazabilidad Hacia Atrás</h2>

    <form method="get" action="@Url.Action("ReportTrazability", "Trazability")" class="d-flex align-items-center gap-2 mb-2">
        <input type="text" name="searchBatch" class="form-control form-control-sm w-auto" placeholder="Buscar lote..." value="@Model?.SearchBatch" style="max-width: 200px;" />
        <button type="submit" class="btn btn-sm btn-primary">Buscar</button>
    </form>


    @if (Model?.Trazabilidad != null && Model.Trazabilidad.Rows.Count > 0)
    {
        <div id="visorTrazabilidad" style="height: 400px; width: 100%; margin-bottom: 30px;"></div>

        <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
        <script>
            const chart = echarts.init(document.getElementById('visorTrazabilidad'));

                const trazabilidadDebug = @Html.Raw(jsonData);
    console.log("🧩 Columnas:", trazabilidadDebug.columnas);
    console.log("🧾 Filas:", trazabilidadDebug.filas);
    console.table(trazabilidadDebug.filas);

            const rows = @Html.Raw(Json.Serialize(
            Model.Trazabilidad.Rows.Cast<System.Data.DataRow>().Select(r => new
            {
                padre = r["batchIdentifier"].ToString(),       // lote padre
                hijo = r["batchname"].ToString(),              // lote hijo
                nombre = r["manufacturingReferenceName"].ToString(),
                id = r["manufacturingReference"].ToString(),
                inicio = r["startDate"].ToString(),
                fin = r["endDate"].ToString()
            })
            ));

            const data = [];
            const links = [];
            const added = new Map();

            (rows.$values || []).forEach(r => {
                // Nodo padre
                if (!added.has(r.padre)) {
                    added.set(r.padre, true);
                    data.push({
                        id: r.padre,
                        name: r.padre,
                        symbolSize: [140, 40],
                        info: {
                            sku: r.nombre,
                            id: r.padre,
                            inicio: r.inicio,
                            fin: r.fin
                        }
                    });
                }

                // Nodo hijo
                if (r.hijo && !added.has(r.hijo)) {
                    added.set(r.hijo, true);
                    data.push({
                        id: r.hijo,
                        name: r.hijo,
                        symbolSize: [140, 40],
                        info: {
                            sku: r.nombre,
                            id: r.hijo,
                            inicio: r.inicio,
                            fin: r.fin
                        }
                    });
                }

                // Conexión
                if (r.padre && r.hijo) {
                    links.push({ source: r.padre, target: r.hijo });
                }
            });

            // Buscar raíz (padre que no es hijo)
            const hijos = new Set(rows.$values.map(r => r.hijo));
            const padres = [...new Set(rows.$values.map(r => r.padre))];
            let rootId = padres.find(p => !hijos.has(p)) || padres[0];

            function buildTreeSafe(rootId, visited = new Set()) {
                if (visited.has(rootId)) return null; // evita recursión infinita
                visited.add(rootId);

                const rootNode = data.find(n => n.id === rootId);
                if (!rootNode) return null;

                const children = uniqueLinks
                    .filter(link => link.source === rootId)
                    .map(link => buildTreeSafe(link.target, new Set(visited)))
                    .filter(child => child !== null);

                return { ...rootNode, children };
            }

            const uniqueLinks = [];
            const seenLinks = new Set();

            links.forEach(link => {
                const key = `${link.source}→${link.target}`;
                if (!seenLinks.has(key)) {
                    seenLinks.add(key);
                    uniqueLinks.push(link);
                }
            });

            chart.setOption({
                tooltip: {
                    trigger: 'item',
                    enterable: true,
                    confine: true,
                    backgroundColor: '#fff',
                    borderColor: '#ccc',
                    borderWidth: 1,
                    textStyle: { color: '#000' },
                    formatter: function (params) {
                        const info = params.data.info;
                        if (!info) return 'Sin información';
                        return `
                                <div style="max-width: 240px; font-size: 12px;">
                                    <b>Lote fabricado</b><br/>
                                    <b>SKU:</b> ${info.sku}<br/>
                                    <b>Identificador:</b> ${info.id}<br/>
                                    <b>Inicio:</b> ${info.inicio}<br/>
                                    <b>Fin:</b> ${info.fin}<br/>
                                    <a href="javascript:void(0)" onclick="filtrarLote('${info.id}')">🔍 Ver detalle</a>
                                </div>`;
                    }
                },
                series: [{
                    type: 'tree',
                    layout: 'orthogonal',
                    orient: 'LR',
                    data: [buildTreeSafe(rootId)],
                    symbol: 'rect',
                    symbolSize: [140, 40],
                    edgeShape: 'polyline',
                    edgeForkPosition: '50%',
                    label: {
                        show: true,
                        formatter: function (params) {
                            return params.data.name || '';
                        },
                        position: 'inside', // 👈 centrado dentro del rectángulo
                        verticalAlign: 'middle',
                        align: 'center',     // 👈 centrado horizontalmente
                        fontSize: 11,
                        color: '#000'        // 👈 opcional, texto en negro para mejor visibilidad
                    },

                    leaves: {
                        label: {
                            show: true,
                            position: 'inside',
                            verticalAlign: 'middle',
                            align: 'center',
                            fontSize: 11,
                            color: '#000'
                        }
                    },
                    itemStyle: {
                        borderColor: '#666',
                        borderWidth: 1,
                        color: '#eef9ff'
                    },
                    expandAndCollapse: true,
                    initialTreeDepth: -1,
                    lineStyle: {
                        color: '#aaa',
                        width: 2
                    }
                }]
            });

            function filtrarLote(id) {
                const form = document.createElement('form');
                form.method = 'get';
                form.action = '@Url.Action("ReportTrazability", "Trazability")';

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'searchBatch';
                input.value = id;

                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        </script>

    }



    <br /><br />
    @if (Model?.StartDate.HasValue == true && Model.EndDate.HasValue == true)
    {
        <div class="d-flex align-items-center gap-3 flex-wrap mb-3">
            <div style="flex: 1; min-width: 280px; padding-bottom: 10px;">
                <div id="rangeSlider"></div>
            </div>

            <div class="small d-flex gap-2 flex-wrap align-items-center">
                <span><strong>Desde:</strong> <span id="displayStart"></span></span>
                <span><strong>Hasta:</strong> <span id="displayEnd"></span></span>

                <form method="get" action="@Url.Action("ReportTrazability", "Trazability")" class="d-flex align-items-center gap-2">
                    <input type="hidden" name="searchBatch" value="@Model.SearchBatch" />
                    <input type="hidden" id="startDateInput" name="startDate" />
                    <input type="hidden" id="endDateInput" name="endDate" />
                    <button type="submit" class="btn btn-sm btn-outline-secondary">🔍 Filtrar</button>
                </form>
            </div>
        </div>
    }
    </BR></BR>
    @if (Model.Checklist != null && Model.Checklist.Rows.Count > 0)
    {
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Lote</th>
                    <th>Identificador Lote</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th>SKU</th>                    
                    <th>Línea</th>
                    <th>Variable</th>
                    <th>Resultado</th>
                    <th>Min</th>
                    <th>Max</th>

                    <!-- Nuevas columnas estadísticas -->
                    <th>Conteo</th>
                    <th>Defectos</th>
                    <th>Media</th>
                    <th>Sigma</th>
                    <th>Cp</th>
                    <th>Cpk</th>
                </tr>
            </thead>
            <tbody>
                @{
                    string previousBatch = string.Empty;
                    string previousManufacturingReference = string.Empty;
                }

                @foreach (System.Data.DataRow batchRow in Model.Trazabilidad.Rows)
                {
                    string batch = batchRow["batch"].ToString();
                    string batchIdentifier = batchRow["batchname"].ToString();
                    string creacionLote = batchRow["startDate"].ToString();
                    string finLote = batchRow["endDate"].ToString();
                    string manufacturingReference = batchRow["manufacturingReferencename"].ToString();

                    // Obtener checklist asociados a este batch
                                    var checklistFiltrados = new List<DataRow>();

                                    foreach (DataRow c in Model.Checklist.Rows)
                                    {
                        bool coincideBatch = !string.IsNullOrEmpty(c["batch"].ToString()) && c["batch"].ToString() == batch;
                        bool coincideReferencia = c["manufacturingReference"].ToString() == batchRow["manufacturingReference"].ToString();

                        if (coincideBatch || coincideReferencia)
                        {
                            checklistFiltrados.Add(c);
                        }
                                    }

                    if (checklistFiltrados.Count == 0)
                    {
                        // Mostrar solo la fila del batch, sin checklist
                        <tr>
                            <td>@batch</td>
                            <td>@batchIdentifier</td>
                            <td>@creacionLote</td>
                            <td>@finLote</td>
                            <td>@manufacturingReference</td>
                            <td colspan="12">Sin registros de checklist</td>
                        </tr>
                    }
                    else
                    {
                        bool mostrarInfoLote = true;

                        foreach (var row in checklistFiltrados)
                        {
                            string variable = row["controlOperationName"].ToString();
                            string key = $"{batch}|{variable}";
                            var stats = Model.Estadisticas.ContainsKey(key) ? Model.Estadisticas[key] : null;

                            <tr>
                                @if (mostrarInfoLote)
                                {
                                    <td>@batch</td>
                                    <td>@batchIdentifier</td>
                                    <td>@creacionLote</td>
                                    <td>@finLote</td>
                                    <td>@manufacturingReference</td>
                                    mostrarInfoLote = false; // Ya mostramos, ahora ocultar en siguientes
                                }
                                else
                                {
                                    <td></td> <!-- Lote -->
                                    <td></td> <!-- Identificador Lote -->
                                    <td></td> <!-- Inicio -->
                                    <td></td> <!-- Fin -->
                                    <td></td> <!-- SKU -->
                                }

                                <td>
                                    @if (!string.IsNullOrEmpty(@row["workplace"].ToString()))
                                    {
                                        @row["workplace"]
                                    }
                                </td>
                                <td>@variable</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(row["resultValue"].ToString()))
                                    {
                                        @row["resultValue"]
                                    }
                                    else
                                    {
                                        if (row["resultAttribute"].ToString() == "1")
                                        {
                                            <i class="fa fa-check-circle text-success" title="OK"></i>
                                        }
                                        else
                                        {
                                            <i class="fa fa-times-circle text-danger" title="NOK"></i>
                                        }
                                    }
                                </td>
                                <td>@row["minTolerance"]</td>
                                <td>@row["maxTolerance"]</td>

                                <td>@(stats?.Conteo ?? 0)</td>
                                <td>@(stats?.Defectos ?? 0)</td>
                                <td>@(stats?.Media.ToString("0.00") ?? "-")</td>
                                <td>@(stats?.Sigma.ToString("0.00") ?? "-")</td>
                                <td>@(stats?.Cp.ToString("0.00") ?? "-")</td>
                                <td>@(stats?.Cpk.ToString("0.00") ?? "-")</td>
                            </tr>
                        }
                    }
                }
            </tbody>
        </table>
    }
    else if (Model.Checklist != null)
    {
        <div class="alert alert-warning">No se encontraron checklist para el lote o rango seleccionado.</div>
    }

    @if (Model.Trazabilidad != null && Model.Trazabilidad.Rows.Count > 0)
{
        <h4>Estructura de Lotes (Jerarquía de Trazabilidad)</h4>
        <table class="table table-bordered table-sm">
            <thead>
                <tr>
                    <th>Padre</th>
                    <th>Hijo</th>
                    <th>Lote</th>
                    <th>Identificador</th>
                    <th>Nivel</th>
                </tr>
            </thead>
            <tbody>
                @foreach (System.Data.DataRow row in Model.Trazabilidad.Rows)
                {
                    <tr>
                        <td>@row["Padre"]</td>
                        <td>@row["Hijo"]</td>
                        <td>@row["batch"]</td>
                        <td>@row["batchIdentifier"]</td>
                        <td>@row["Nivel"]</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <button class="btn btn-primary" onclick="window.print()">Imprimir Reporte</button>
</div>

@section Scripts {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

    @if (Model.StartDate.HasValue && Model.EndDate.HasValue)
    {
        <script>
            const rangeSlider = document.getElementById('rangeSlider');
            const displayStart = document.getElementById('displayStart');
            const displayEnd = document.getElementById('displayEnd');
            const inputStart = document.getElementById('startDateInput');
            const inputEnd = document.getElementById('endDateInput');

            // 🎯 Rango de fechas reales desde el modelo
            const dateStart = new Date("@Model.StartDate.Value.ToString("yyyy-MM-ddTHH:mm:ss")");
            const dateEnd = new Date("@Model.EndDate.Value.ToString("yyyy-MM-ddTHH:mm:ss")");


            // ⏱ Total en milisegundos
            const totalMs = dateEnd - dateStart;

            // 🕓 Crear marcas horarias cada 1 hora
            function generatePipPositions(totalMs) {
                const positions = [];
                const hourInMs = 60 * 60 * 1000;
                const totalHours = Math.floor(totalMs / hourInMs);
                for (let i = 0; i <= totalHours; i++) {
                    const percent = (i * hourInMs * 100) / totalMs;
                    positions.push(Math.min(percent, 100));
                }
                return positions;
            }

            noUiSlider.create(rangeSlider, {
                start: [0, totalMs],
                connect: true,
                step: 15 * 60 * 1000, // cada 15 minutos
                range: {
                    min: 0,
                    max: totalMs
                },
                format: {
                    to: v => parseInt(v),
                    from: v => parseInt(v)
                },
                tooltips: [
                    {
                        to: v => new Date(dateStart.getTime() + v).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        from: () => 0
                    },
                    {
                        to: v => new Date(dateStart.getTime() + v).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        from: () => 0
                    }
                ],
                pips: {
                    mode: 'positions',
                    values: generatePipPositions(totalMs),
                    density: 2,
                    stepped: true,
                    format: {
                        to: v => {
                            const time = new Date(dateStart.getTime() + v);
                            return time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        }
                    }
                }

            });

            // 📅 Mostrar valores formateados
            rangeSlider.noUiSlider.on('update', function (values) {
                const msStart = parseInt(values[0]);
                const msEnd = parseInt(values[1]);

                const newStart = new Date(dateStart.getTime() + msStart);
                const newEnd = new Date(dateStart.getTime() + msEnd);

                displayStart.textContent = newStart.toLocaleString('es-MX', { hour: '2-digit', minute: '2-digit' });
                displayEnd.textContent = newEnd.toLocaleString('es-MX', { hour: '2-digit', minute: '2-digit' });



                inputStart.value = toLocalDatetimeValue(newStart);
                inputEnd.value = toLocalDatetimeValue(newEnd);

                console.log("🧪 Fecha generada - inputStart.value:", inputStart.value);
                console.log("🧪 Fecha generada - inputEnd.value:", inputEnd.value);
            });

              function toLocalDatetimeValue(date) {
                    return date.getFullYear() + '-' +
                        String(date.getMonth() + 1).padStart(2, '0') + '-' +
                        String(date.getDate()).padStart(2, '0') + 'T' +
                        String(date.getHours()).padStart(2, '0') + ':' +
                        String(date.getMinutes()).padStart(2, '0');
                }

            // Inicializar al máximo
            rangeSlider.noUiSlider.set([0, totalMs]);

        </script>
    }
}


