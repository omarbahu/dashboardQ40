@{
    ViewData["Title"] = "Quality Executive Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .quality-root {
        background-color: #f8fafc; /* gris muy suave */
        color: #111827;
        padding: 1.5rem 1.5rem 3rem 1.5rem;
        border-radius: 12px;
        margin-top: 15px;
    }

        .quality-root h4 {
            color: #111827;
        }

    .quality-filters .form-select {
        background-color: #ffffff;
        border-color: #d1d5db;
        color: #111827;
        font-size: 0.8rem;
    }

        .quality-filters .form-select:focus {
            box-shadow: none;
            border-color: #0d6efd;
        }

    .card-dark {
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
        color: #111827;
    }

    .kpi-title {
        font-size: 0.8rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: .05em;
    }

    .kpi-mu {
        font-size: 1.35rem;
        font-weight: 600;
        color: #b91c1c; /* rojo suave */
    }

    .kpi-sub {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .kpi-badge {
        font-size: 0.7rem;
        padding: 0.15rem .35rem;
        border-radius: 999px;
        background-color: #eff6ff;
        color: #1d4ed8;
    }

    .top-label {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .table-dark-lite {
        font-size: 0.8rem;
    }

        .table-dark-lite thead {
            background-color: #e5e7eb;
        }

        .table-dark-lite tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .table-dark-lite tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }

        .table-dark-lite th,
        .table-dark-lite td {
            border-color: #e5e7eb !important;
        }

    .badge-level {
        font-size: 0.7rem;
        border-radius: 999px;
        padding: 0.12rem .45rem;
        text-transform: uppercase;
        color: #ffffff;
    }

        .badge-level.badge-bad {
            background-color: #b91c1c;
        }

        .badge-level.badge-mid {
            background-color: #f59e0b;
        }

        .badge-level.badge-good {
            background-color: #16a34a;
        }

    .section-title {
        font-size: 0.8rem;
        color: #6b7280;
        margin-bottom: .3rem;
    }
</style>


<div class="quality-root" data-program-required="DQcompyx">
    <!-- Top bar: título + filtros -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-semibold mb-0">Quality Executive Dashboard</h4>

        <div class="d-flex gap-2 quality-filters">
            <select id="vistaSelector" class="form-select form-select-sm">
                <option value="global">🌎 Global</option>
                <option value="regional">📍 Country</option>
                <option value="planta">🏭 Plant</option>
            </select>

            <select id="paisSelector" class="form-select form-select-sm" style="display:none;"></select>
            <select id="plantaSelector" class="form-select form-select-sm" style="display:none;"></select>

            <select id="variableSelector" class="form-select form-select-sm">
                <option value="brix">Brix / Concentración</option>
                <option value="co2">Carbonatación (CO₂)</option>
                <option value="net">Contenido neto</option>
                <option value="torque">Torque de tapa</option>
                <option value="density">Densidad</option>
            </select>
        </div>
    </div>

    <div id="contenidoDashboard"></div>
</div>

@{
    var dashboardUrl = Url.Action("Index", "Dashboard");
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script>
        // ===== Configuración general dummy =====
        const variableLabels = {
            brix: "Brix / Concentración",
            co2: "Carbonatación (CO₂)",
            net: "Contenido neto",
            torque: "Torque de tapa",
            density: "Densidad"
        };
        const allVariables = Object.keys(variableLabels);

        const plantasPorPais = {
            "Mexico": ["Insurgentes", "Favorita", "Mexicali"],
            "Peru": ["Pucusana", "Zarate"],
            "Ecuador": ["Guayaquil", "Quito"],
            "Argentina": ["Salta", "Tucuman"],
            "USA": ["North Point", "McAllen"]
        };

        const dashboardUrl = '@dashboardUrl';

        function randomStat() {
            return {
                mu: (Math.random() * 5 + 10).toFixed(2),   // 10–15
                cp: (Math.random() * 1.4 + 0.3).toFixed(2),
                cpk: (Math.random() * 1.4 + 0.3).toFixed(2),
                oos: (Math.random() * 8).toFixed(1)       // 0–8 %
            };
        }

        function buildStatsForItems(items) {
            const result = {};
            items.forEach(item => {
                result[item] = {};
                allVariables.forEach(v => {
                    result[item][v] = randomStat();
                });
            });
            return result;
        }

        $(function () {
            const $vista = $('#vistaSelector');
            const $pais = $('#paisSelector');
            const $planta = $('#plantaSelector');
            const $varSel = $('#variableSelector');

            // Inicializar países
            Object.keys(plantasPorPais).forEach(p => {
                $pais.append(`<option value="${p}">${p}</option>`);
            });

            function actualizarPlantas(pais) {
                const plantas = plantasPorPais[pais] || [];
                $planta.empty();
                plantas.forEach(pl => $planta.append(`<option value="${pl}">${pl}</option>`));
            }

            function renderDashboard() {
                const vista = $vista.val();
                const paisVal = $pais.val();
                const plantaVal = $planta.val();
                const varKey = $varSel.val();
                const varLabel = variableLabels[varKey] || varKey.toUpperCase();

                let nivelLabel = "";
                let itemsNivel = [];

                if (vista === "global") {
                    nivelLabel = "Country";
                    itemsNivel = Object.keys(plantasPorPais);
                } else if (vista === "regional" && paisVal) {
                    nivelLabel = "Plant";
                    itemsNivel = plantasPorPais[paisVal] || [];
                } else if (vista === "planta" && plantaVal) {
                    nivelLabel = "Line";
                    itemsNivel = ["Line 01", "Line 02", "Line 03", "Line 04"];
                } else {
                    $('#contenidoDashboard').html("<div class='text-muted'>Select a level to view data.</div>");
                    return;
                }

                const statsByItem = buildStatsForItems(itemsNivel);

                // Resumen por variable (promedio de todos los items en el scope)
                const summaryVars = {};
                allVariables.forEach(v => {
                    let sumMu = 0, sumCp = 0, sumCpk = 0, sumOos = 0;
                    itemsNivel.forEach(it => {
                        const st = statsByItem[it][v];
                        sumMu += parseFloat(st.mu);
                        sumCp += parseFloat(st.cp);
                        sumCpk += parseFloat(st.cpk);
                        sumOos += parseFloat(st.oos);
                    });
                    const n = itemsNivel.length || 1;
                    summaryVars[v] = {
                        mu: (sumMu / n).toFixed(2),
                        cp: (sumCp / n).toFixed(2),
                        cpk: (sumCpk / n).toFixed(2),
                        oos: (sumOos / n).toFixed(1)
                    };
                });

                // ====== Layout HTML ======
                let scopeTitle = vista === "global"
                    ? "Global"
                    : (vista === "regional" ? paisVal : plantaVal);

                let html = "";

                // -------- Top KPIs (5 tarjetas) --------
                html += `<div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="top-label">Scope: <strong>${scopeTitle}</strong></div>
                                    <div class="top-label">Focused variable: <strong>${varLabel}</strong></div>
                                 </div>`;

                html += `<div class="row g-3 mb-3">`;
                allVariables.forEach(v => {
                    const s = summaryVars[v];
                    html += `
                                <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                                  <div class="card-dark p-3 h-100">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="kpi-title">${variableLabels[v]}</div>
                                        <span class="kpi-badge">Cpk ${s.cpk}</span>
                                    </div>
                                    <div class="mt-1">
                                      <div class="kpi-mu">&mu; ${s.mu}</div>
                                      <div class="kpi-sub">Cp: ${s.cp} · OOS: ${s.oos}%</div>
                                    </div>
                                  </div>
                                </div>
                            `;
                });
                html += `</div>`;

                // -------- Middle row: Trend & Cpk by level --------
                html += `
                            <div class="row g-3 mb-3">
                              <div class="col-lg-7">
                                <div class="card-dark p-3 h-100">
                                  <div class="section-title">Trend · ${varLabel}</div>
                                  <div id="chartTrend" style="height:280px;"></div>
                                </div>
                              </div>
                              <div class="col-lg-5">
                                <div class="card-dark p-3 h-100">
                                  <div class="section-title">Cpk by ${nivelLabel.toLowerCase()} · ${varLabel}</div>
                                  <div id="chartCpkLevel" style="height:280px;"></div>
                                </div>
                              </div>
                            </div>
                        `;

                // -------- Bottom row: Top risks + Donuts --------
                html += `
                            <div class="row g-3">
                              <div class="col-lg-7">
                                <div class="card-dark p-3 h-100">
                                  <div class="section-title">Top risks (lowest Cpk)</div>
                                  <div class="table-responsive">
                                    <table class="table table-dark-lite table-sm mb-0">
                                      <thead>
                                        <tr>
                                          <th>${nivelLabel}</th>
                                          <th>Variable</th>
                                          <th>&mu;</th>
                                          <th>Cp</th>
                                          <th>Cpk</th>
                                          <th>OOS %</th>
                                        </tr>
                                      </thead>
                                      <tbody id="tbodyRisks"></tbody>
                                    </table>
                                  </div>
                                </div>
                              </div>
                              <div class="col-lg-5">
                                <div class="card-dark p-3 h-100">
                                  <div class="section-title mb-2">OOS breakdown</div>
                                  <div class="row g-2">
                                    <div class="col-4"><div id="donutBrix" style="height:180px;"></div></div>
                                    <div class="col-4"><div id="donutNet" style="height:180px;"></div></div>
                                    <div class="col-4"><div id="donutTorque" style="height:180px;"></div></div>
                                  </div>
                                </div>
                              </div>
                            </div>
                        `;

                $('#contenidoDashboard').html(html);

                // ====== Charts ======

                // --- Trend chart (últimos 7 días) ---
                const trendDom = document.getElementById('chartTrend');
                const trendChart = echarts.init(trendDom);
                const days = ["D-6", "D-5", "D-4", "D-3", "D-2", "D-1", "Hoy"];
                const baseMu = parseFloat(summaryVars[varKey].mu);
                const trendData = days.map((d, i) =>
                    (baseMu + (Math.random() - 0.5) * 1.2).toFixed(2)
                );

                trendChart.setOption({
                    tooltip: { trigger: 'axis' },
                    grid: { left: 40, right: 20, bottom: 35, top: 20 },
                    xAxis: { type: 'category', data: days },
                    yAxis: { type: 'value' },
                    series: [{
                        name: '&mu;',
                        type: 'line',
                        smooth: true,
                        data: trendData,
                        areaStyle: { opacity: 0.15 }
                    }]
                });

                // --- Cpk by level (bar) ---
                const cpkDom = document.getElementById('chartCpkLevel');
                const cpkChart = echarts.init(cpkDom);
                const cpkData = itemsNivel.map(it =>
                    parseFloat(statsByItem[it][varKey].cpk)
                );

                cpkChart.setOption({
                    tooltip: { trigger: 'axis' },
                    grid: { left: 70, right: 20, bottom: 40, top: 20 },
                    xAxis: { type: 'category', data: itemsNivel },
                    yAxis: { type: 'value', min: 0, max: 2 },
                    series: [{
                        type: 'bar',
                        data: cpkData,
                        itemStyle: { color: '#dc2626' },
                        markLine: {
                            silent: true,
                            data: [{ yAxis: 1.33, name: 'Target 1.33' }]
                        }
                    }]
                });

                // --- Tabla Top risks ---
                const riskList = [];
                itemsNivel.forEach(it => {
                    allVariables.forEach(v => {
                        const st = statsByItem[it][v];
                        riskList.push({
                            item: it,
                            variable: variableLabels[v],
                            mu: st.mu,
                            cp: st.cp,
                            cpk: parseFloat(st.cpk),
                            oos: st.oos
                        });
                    });
                });
                riskList.sort((a, b) => a.cpk - b.cpk);
                const top = riskList.slice(0, 8);
                let rows = "";
                top.forEach(r => {
                    const badgeClass = r.cpk < 1 ? "badge-bad" : (r.cpk < 1.33 ? "badge-mid" : "badge-good");
                    rows += `
                                <tr>
                                  <td>${r.item}</td>
                                  <td>${r.variable}</td>
                                  <td>${r.mu}</td>
                                  <td>${r.cp}</td>
                                  <td>
                                    <span class="badge-level ${badgeClass}">${r.cpk.toFixed(2)}</span>
                                  </td>
                                  <td>${r.oos}</td>
                                </tr>
                            `;
                });
                $('#tbodyRisks').html(rows);

                // --- Donuts: Brix / Net / Torque ---
                function buildDonut(domId, label, statsSummary) {
                    const donut = echarts.init(document.getElementById(domId));
                    // proporciones dummy en base a OOS
                    const oos = parseFloat(statsSummary.oos);
                    const border = Math.min(oos * 1.5, 20);
                    const inSpec = Math.max(100 - oos - border, 0);
                    donut.setOption({
                        title: {
                            text: label,
                            left: 'center',
                            top: 'center',
                            textStyle: { fontSize: 11, color: '#e5e7eb', fontWeight: 500 }
                        },
                        tooltip: { trigger: 'item' },
                        series: [{
                            type: 'pie',
                            radius: ['55%', '80%'],
                            avoidLabelOverlap: false,
                            label: { show: false },
                            labelLine: { show: false },
                            data: [
                                { value: inSpec, name: 'In spec' },
                                { value: border, name: 'Borderline' },
                                { value: oos, name: 'OOS' }
                            ]
                        }]
                    });
                }

                buildDonut('donutBrix', 'Brix', summaryVars['brix']);
                buildDonut('donutNet', 'Net', summaryVars['net']);
                buildDonut('donutTorque', 'Torque', summaryVars['torque']);
            }

            // Eventos
            $vista.on('change', function () {
                const v = $(this).val();
                $('#paisSelector').toggle(v !== 'global');
                $('#plantaSelector').toggle(v === 'planta');
                if (v !== 'global') {
                    actualizarPlantas($pais.val());
                }
                renderDashboard();
            });

            $pais.on('change', function () {
                actualizarPlantas(this.value);
                renderDashboard();
            });

            $planta.on('change', renderDashboard);
            $varSel.on('change', renderDashboard);

            // Init
            const firstCountry = Object.keys(plantasPorPais)[0];
            $pais.val(firstCountry);
            actualizarPlantas(firstCountry);
            renderDashboard();
        });
    </script>
}
